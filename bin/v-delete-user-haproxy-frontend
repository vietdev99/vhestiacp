#!/bin/bash
# info: delete HAProxy frontend for user
# options: USER NAME
#
# example: v-delete-user-haproxy-frontend admin web_front
#
# This function deletes a HAProxy frontend configuration for a user.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
name=$2

# Includes
# shellcheck source=/etc/vhestia/hestia.conf
source /etc/vhestia/hestia.conf
# shellcheck source=/usr/local/vhestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER NAME'
is_format_valid 'user' 'name'
is_object_valid 'user' 'USER' "$user"

# Check if frontend exists
haproxy_conf="$HESTIA/data/users/$user/haproxy.conf"
if [ ! -f "$haproxy_conf" ]; then
    echo "Error: No HAProxy configuration found for user $user"
    exit 1
fi

if ! grep -q "^FRONTEND='$name'" "$haproxy_conf"; then
    echo "Error: Frontend '$name' not found for user $user"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Get port before deletion
port=$(grep "^FRONTEND='$name'" "$haproxy_conf" | grep -oP "PORT='\K[^']+")

# Remove frontend config file
frontend_cfg="$HOMEDIR/$user/conf/haproxy/frontends/${name}.cfg"
if [ -f "$frontend_cfg" ]; then
    rm -f "$frontend_cfg"
fi

# Remove from user's haproxy.conf
sed -i "/^FRONTEND='$name'/d" "$haproxy_conf"

# Remove from port allocation
if [ -n "$port" ]; then
    sed -i "/${user}:${name}:${port}/d" "$HESTIA/data/haproxy_user_ports.conf"
fi

# Rebuild main HAProxy config
$BIN/v-rebuild-haproxy-conf

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

$BIN/v-log-action "$user" "Info" "HAProxy" "Deleted frontend $name"

echo "Frontend '$name' deleted successfully"

exit 0
