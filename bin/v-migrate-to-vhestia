#!/bin/bash
# info: migrate from HestiaCP/old VHestiaCP to new VHestiaCP paths
# options: [--force]
#
# This script migrates an existing HestiaCP or VHestiaCP installation
# from /usr/local/hestia to /usr/local/vhestia paths.
#
# The migration process:
# 1. Stops all services
# 2. Moves data directory to new location
# 3. Creates symlinks for backward compatibility
# 4. Updates configuration files
# 5. Updates cron jobs
# 6. Restarts services

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

HESTIA_OLD="/usr/local/hestia"
VHESTIA_NEW="/usr/local/vhestia"
FORCE="${1:-}"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo ""
echo "=============================================="
echo "   VHestiaCP Migration Script"
echo "=============================================="
echo ""

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo -e "${RED}Error: This script must be run as root${NC}"
    exit 1
fi

# Check if old installation exists
if [ ! -d "$HESTIA_OLD" ] && [ ! -L "$HESTIA_OLD" ]; then
    echo -e "${RED}Error: No existing installation found at $HESTIA_OLD${NC}"
    exit 1
fi

# Check if it's already a symlink (already migrated)
if [ -L "$HESTIA_OLD" ]; then
    target=$(readlink -f "$HESTIA_OLD")
    if [ "$target" = "$VHESTIA_NEW" ]; then
        echo -e "${GREEN}Already migrated: $HESTIA_OLD -> $VHESTIA_NEW${NC}"
        exit 0
    fi
fi

# Check if new path already exists and is not empty
if [ -d "$VHESTIA_NEW" ] && [ "$(ls -A $VHESTIA_NEW 2>/dev/null)" ]; then
    if [ "$FORCE" != "--force" ]; then
        echo -e "${RED}Error: $VHESTIA_NEW already exists and is not empty${NC}"
        echo "Use --force to overwrite"
        exit 1
    fi
fi

echo -e "${BLUE}Source:${NC}      $HESTIA_OLD"
echo -e "${BLUE}Destination:${NC} $VHESTIA_NEW"
echo ""

if [ "$FORCE" != "--force" ]; then
    echo -e "${YELLOW}This will migrate your installation to VHestiaCP paths.${NC}"
    echo -e "${YELLOW}A symlink will be created for backward compatibility.${NC}"
    echo ""
    read -p "Continue? (y/N): " confirm
    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        echo "Migration cancelled."
        exit 0
    fi
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo ""
echo -e "${BLUE}[1/6] Stopping services...${NC}"

# Stop PM2 panel
pm2 stop vhestia-panel 2>/dev/null || true
pm2 stop hestia-panel 2>/dev/null || true

# Stop hestia service if exists
systemctl stop hestia 2>/dev/null || true

echo -e "  ${GREEN}✓${NC} Services stopped"

echo -e "${BLUE}[2/6] Creating backup...${NC}"

BACKUP_DIR="/root/vhestia_migration_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

# Backup configs
if [ -d "/etc/hestiacp" ]; then
    cp -r /etc/hestiacp "$BACKUP_DIR/"
fi
if [ -f "$HESTIA_OLD/conf/hestia.conf" ]; then
    cp "$HESTIA_OLD/conf/hestia.conf" "$BACKUP_DIR/"
fi

echo -e "  ${GREEN}✓${NC} Backup created at $BACKUP_DIR"

echo -e "${BLUE}[3/6] Moving installation...${NC}"

# Create new directory
mkdir -p "$VHESTIA_NEW"

# Move contents (not the directory itself to preserve structure)
if [ -d "$HESTIA_OLD" ] && [ ! -L "$HESTIA_OLD" ]; then
    # Move all contents
    cp -a "$HESTIA_OLD"/* "$VHESTIA_NEW"/ 2>/dev/null || true
    cp -a "$HESTIA_OLD"/.[!.]* "$VHESTIA_NEW"/ 2>/dev/null || true

    # Remove old directory and create symlink
    rm -rf "$HESTIA_OLD"
fi

# Create symlink for backward compatibility
ln -sf "$VHESTIA_NEW" "$HESTIA_OLD"

echo -e "  ${GREEN}✓${NC} Installation moved"
echo -e "  ${GREEN}✓${NC} Symlink created: $HESTIA_OLD -> $VHESTIA_NEW"

echo -e "${BLUE}[4/6] Updating configuration...${NC}"

# Create new config directory
mkdir -p /etc/vhestia

# Create vhestia.conf
cat > /etc/vhestia/vhestia.conf << 'EOF'
# VHestiaCP Configuration
# Do not edit this file directly, use /etc/vhestia/local.conf instead

export VHESTIA='/usr/local/vhestia'
export HESTIA="$VHESTIA"

[[ -f /etc/vhestia/local.conf ]] && source /etc/vhestia/local.conf
EOF

# Copy local.conf if exists
if [ -f "/etc/hestiacp/local.conf" ]; then
    cp /etc/hestiacp/local.conf /etc/vhestia/
fi

# Create symlink for /etc/hestiacp
if [ -d "/etc/hestiacp" ] && [ ! -L "/etc/hestiacp" ]; then
    rm -rf /etc/hestiacp
fi
ln -sf /etc/vhestia /etc/hestiacp

echo -e "  ${GREEN}✓${NC} Configuration updated"

echo -e "${BLUE}[5/6] Updating cron jobs...${NC}"

# Update cron jobs for all users
if [ -d "$VHESTIA_NEW/data/users" ]; then
    for user_dir in "$VHESTIA_NEW/data/users"/*; do
        if [ -d "$user_dir" ]; then
            user=$(basename "$user_dir")
            # Update user's crontab
            if crontab -l -u "$user" 2>/dev/null | grep -q "/usr/local/hestia"; then
                crontab -l -u "$user" 2>/dev/null | \
                    sed "s|/usr/local/hestia|/usr/local/vhestia|g" | \
                    crontab -u "$user" - 2>/dev/null || true
                echo -e "  ${GREEN}✓${NC} Updated cron for user: $user"
            fi
        fi
    done
fi

# Update root crontab
if crontab -l 2>/dev/null | grep -q "/usr/local/hestia"; then
    crontab -l 2>/dev/null | \
        sed "s|/usr/local/hestia|/usr/local/vhestia|g" | \
        crontab - 2>/dev/null || true
    echo -e "  ${GREEN}✓${NC} Updated root cron"
fi

echo -e "${BLUE}[6/6] Restarting services...${NC}"

# Restart PM2
if [ -f "$VHESTIA_NEW/web_v2/ecosystem.config.cjs" ]; then
    cd "$VHESTIA_NEW/web_v2"
    pm2 start ecosystem.config.cjs 2>/dev/null || true
    pm2 save 2>/dev/null || true
fi

# Restart other services
systemctl restart nginx 2>/dev/null || true
systemctl restart apache2 2>/dev/null || true

echo -e "  ${GREEN}✓${NC} Services restarted"

#----------------------------------------------------------#
#                       Summary                            #
#----------------------------------------------------------#

echo ""
echo "=============================================="
echo "   Migration Complete!"
echo "=============================================="
echo ""
echo "Summary:"
echo "  - Installation moved to: $VHESTIA_NEW"
echo "  - Symlink created: $HESTIA_OLD -> $VHESTIA_NEW"
echo "  - Config: /etc/vhestia/vhestia.conf"
echo "  - Symlink: /etc/hestiacp -> /etc/vhestia"
echo "  - Backup: $BACKUP_DIR"
echo ""
echo "All existing scripts will continue to work due to symlinks."
echo ""
