#!/bin/bash
# info: setup VHestiaCP web interface (web_v2)
# options: NONE
#
# example: v-setup-vhestia-web
#
# This function sets up the VHestiaCP web_v2 interface:
# - Removes hestia-nginx package (not needed, conflicts with port 8083)
# - Masks hestia service to prevent auto-restart
# - Sets up PM2 for web_v2 if not already running
#
# Note: The main nginx server (handling web domains) is NOT affected.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Includes
# Fix VHestiaCP environment paths if missing
if [ ! -L "/usr/local/vhestia" ] && [ -d "/usr/local/hestia" ]; then
    ln -sf /usr/local/hestia /usr/local/vhestia
fi

if [ ! -L "/etc/vhestia" ] && [ -d "/usr/local/hestia/conf" ]; then
    ln -sfn /usr/local/hestia/conf /etc/vhestia
fi

source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Setting up VHestiaCP web interface..."

# Step 1: Stop and disable hestia service (controls hestia-nginx)
echo "Disabling hestia service..."
systemctl stop hestia 2>/dev/null || true
systemctl disable hestia 2>/dev/null || true
systemctl mask hestia 2>/dev/null || true

# Step 2: Remove hestia-nginx package if installed
# This package is not needed for VHestiaCP - we use web_v2 (Express/PM2) instead
if dpkg -l hestia-nginx 2>/dev/null | grep -q "^ii"; then
    echo "Removing hestia-nginx package..."

    # First, stop any nginx instances that might be running from hestia-nginx
    pkill -f "nginx.*hestia" 2>/dev/null || true

    # Remove the package
    export DEBIAN_FRONTEND=noninteractive
    apt-get remove --purge -y hestia-nginx 2>/dev/null || true
    apt-get autoremove -y 2>/dev/null || true

    # Clean up any leftover files
    rm -rf /usr/local/vhestia/nginx 2>/dev/null || true

    echo "hestia-nginx package removed"
else
    echo "hestia-nginx package not installed (OK)"
fi

# Step 3: Verify main nginx is still running (should not be affected)
if systemctl is-active --quiet nginx; then
    echo "Main nginx server: running (OK)"
else
    echo "Warning: Main nginx server is not running"
    echo "Starting nginx..."
    systemctl start nginx
fi

# Step 4: Setup web_v2 service (prefer systemd over PM2)
install_dependencies() {
    echo "Installing web_v2 dependencies..."
    cd "$HESTIA/web_v2/server" || return
    if [ -f "package.json" ]; then
        npm install --omit=dev --no-audit --no-fund
    fi

    # Setup CLI mailer
    if [ -f "$HESTIA/web_v2/server/cli/send-mail.js" ]; then
        chmod +x "$HESTIA/web_v2/server/cli/send-mail.js"
        echo "VHestiaCP mailer configured."
    fi
}

# Check if systemd service is active
if systemctl is-active --quiet vhestia-panel; then
    echo "VHestiaCP web_v2 (systemd): running (OK)"
# Check if PM2 is running (legacy)
elif command -v pm2 &>/dev/null && pm2 list 2>/dev/null | grep -q "vhestia"; then
    echo "VHestiaCP web_v2 (PM2): running (OK)"
    echo "Note: Consider migrating to systemd for better resource usage"
else
    echo "VHestiaCP web_v2 not running. Setting up..."

    install_dependencies

    # Install systemd service file
    if [ -f "$HESTIA/install/deb/vhestia-panel.service" ]; then
        echo "Installing systemd service..."
        cp "$HESTIA/install/deb/vhestia-panel.service" /etc/systemd/system/
        systemctl daemon-reload
        systemctl enable vhestia-panel
        systemctl start vhestia-panel

        if systemctl is-active --quiet vhestia-panel; then
            echo "VHestiaCP web_v2 started successfully (systemd)"
        else
            echo "Error: Failed to start vhestia-panel service"
            echo "Check logs: journalctl -u vhestia-panel"
        fi
    # Fallback to PM2 if systemd service file not available
    elif command -v pm2 &>/dev/null && [ -f "$HESTIA/web_v2/ecosystem.config.cjs" ]; then
        echo "Starting web_v2 with PM2..."
        cd "$HESTIA/web_v2" || exit 1
        pm2 start ecosystem.config.cjs
        pm2 save
    else
        echo "Error: Cannot start VHestiaCP web_v2"
        echo "Missing systemd service file and PM2 not available"
    fi
fi

# Step 5: Verify port 8083 is accessible
echo ""
echo "Checking port 8083..."
if ss -tlnp | grep -q ":8083"; then
    service_info=$(ss -tlnp | grep ":8083" | head -1)
    echo "Port 8083 is in use by: $service_info"
else
    echo "Warning: Nothing is listening on port 8083"
fi

#----------------------------------------------------------#
#                       Logging                            #
#----------------------------------------------------------#

$BIN/v-log-action "system" "Info" "System" "VHestiaCP web interface setup completed"
log_event "$OK" "$ARGUMENTS"

echo ""
echo "VHestiaCP web interface setup completed!"
echo "Access panel at: https://$(hostname):8083"

exit 0
