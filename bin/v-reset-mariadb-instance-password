#!/bin/bash
# info: reset/create root password for mariadb instance
# options: INSTANCE
#
# example: v-reset-mariadb-instance-password btest2
#
# This function resets or creates root password for a MariaDB instance.
# Uses safe shutdown + skip-grant-tables method for instances without socket auth.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

instance=${1:-default}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

if [ -z "$instance" ]; then
    echo "Error: Instance name is required"
    exit 1
fi

#----------------------------------------------------------#
#                  Instance Configuration                  #
#----------------------------------------------------------#

MYSQL_PORT=3306
MYSQL_SOCKET="/var/run/mysqld/mysqld.sock"
SERVICE_NAME="mariadb"
DATA_DIR="/var/lib/mysql"

if [ "$instance" != "default" ]; then
    if [ -f "/etc/mysql-instances/${instance}.cnf" ]; then
        MYSQL_PORT=$(grep -E "^port\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
        MYSQL_SOCKET=$(grep -E "^socket\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
        DATA_DIR=$(grep -E "^datadir\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
        SERVICE_NAME="mariadb-${instance}"
    else
        echo "Error: Instance config not found: /etc/mysql-instances/${instance}.cnf"
        exit 1
    fi
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Resetting root password for MariaDB instance: $instance..."

# Generate new password
NEW_PASSWORD=$(< /dev/urandom tr -dc 'A-Za-z0-9' | head -c 20)

# Method 1: Try using existing password from config
EXISTING_PASS=""
if [ -f "$HESTIA/conf/mariadb-${instance}.conf" ]; then
    source "$HESTIA/conf/mariadb-${instance}.conf"
    EXISTING_PASS="$ROOT_PASSWORD"
fi

if systemctl is-active --quiet "$SERVICE_NAME"; then
    echo "Service is running, attempting active password update..."
    
    # Try with existing password
    if [ -n "$EXISTING_PASS" ] && [ -S "$MYSQL_SOCKET" ]; then
        if mysqladmin --socket="$MYSQL_SOCKET" -u root -p"$EXISTING_PASS" password "$NEW_PASSWORD" 2>/dev/null; then
            echo "Password updated using existing credentials."
            goto_save=true
        fi
    fi

    # Try socket auth (no password)
    if [ "$goto_save" != "true" ] && [ -S "$MYSQL_SOCKET" ]; then
        if mysqladmin --socket="$MYSQL_SOCKET" -u root password "$NEW_PASSWORD" 2>/dev/null; then
            echo "Password updated via socket auth."
            goto_save=true
        fi
    fi
     
    # Try with no password (if empty)
    if [ "$goto_save" != "true" ] && [ -S "$MYSQL_SOCKET" ]; then
         if mysqladmin --socket="$MYSQL_SOCKET" -u root --password="" password "$NEW_PASSWORD" 2>/dev/null; then
             echo "Password updated (was empty)."
             goto_save=true
         fi
    fi
fi

if [ "$goto_save" != "true" ]; then
    # Method 3: Safe mode - stop, start with skip-grant-tables, reset, restart
    echo "Using safe mode to reset password..."
    
    # Stop the instance
    echo "Stopping service $SERVICE_NAME..."
    systemctl stop $SERVICE_NAME 2>/dev/null || true
    sleep 2
    
    # Double check if pid exists and process is running, force kill if needed
    PID_FILE=$(grep -E "^pid-file\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
    if [ -z "$PID_FILE" ] && [ "$instance" == "default" ]; then
         PID_FILE="/var/run/mysqld/mysqld.pid"
    fi

    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null; then
            echo "Force killing stuck process $PID..."
            kill -9 "$PID"
        fi
    fi
    
    echo "Starting mysqld_safe..."
    
    # Ensure log directory exists
    LOG_DIR="/var/log/mysql"
    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR"
        chown mysql:mysql "$LOG_DIR"
        chmod 750 "$LOG_DIR"
    fi
    
    # Ensure log file exists and is writable
    LOG_FILE=$(grep -E "^log_error\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
    if [ -n "$LOG_FILE" ]; then
        touch "$LOG_FILE"
        chown mysql:mysql "$LOG_FILE"
    fi

    mysqld_safe --defaults-file="/etc/mysql-instances/${instance}.cnf" --skip-grant-tables --skip-networking &
    SAFE_PID=$!
    
    # Wait for socket to appear
    echo "Waiting for socket..."
    for i in {1..15}; do
        if [ -S "$MYSQL_SOCKET" ]; then
            break
        fi
        sleep 1
    done
    
    if [ -S "$MYSQL_SOCKET" ]; then
        # Reset password
        echo "Applying password change..."
        mysql --socket="$MYSQL_SOCKET" -u root <<EOF
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY '$NEW_PASSWORD';
FLUSH PRIVILEGES;
EOF
        
        if [ $? -ne 0 ]; then
            # Try with CREATE USER for fresh install
            mysql --socket="$MYSQL_SOCKET" -u root <<EOF
FLUSH PRIVILEGES;
CREATE USER IF NOT EXISTS 'root'@'localhost' IDENTIFIED BY '$NEW_PASSWORD';
ALTER USER 'root'@'localhost' IDENTIFIED BY '$NEW_PASSWORD';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;
FLUSH PRIVILEGES;
EOF
        fi
        
        # Stop mysqld_safe
        echo "Stopping mysqld_safe..."
        mysqladmin --socket="$MYSQL_SOCKET" -u root shutdown 2>/dev/null
        
        # Verify safe shutdown
        sleep 2
        if ps -p "$SAFE_PID" > /dev/null; then
             kill "$SAFE_PID" 2>/dev/null
        fi
    else
        echo "Error: Socket did not appear. Check logs."
    fi
    
    # Restart instance normally
    echo "Starting service $SERVICE_NAME..."
    systemctl start $SERVICE_NAME
    sleep 5
fi

# Verify
if mysql --socket="$MYSQL_SOCKET" -u root -p"$NEW_PASSWORD" -e "SELECT 1;" &>/dev/null; then
    echo "Password reset verified successfully!"
else
    echo "Warning: Could not verify password. Instance may need manual check."
fi

# Save password to config
CONF_DIR="$HESTIA/conf"
mkdir -p "$CONF_DIR"

CONF_FILE="$CONF_DIR/mariadb-${instance}.conf"
cat > "$CONF_FILE" <<EOF
# MariaDB instance: $instance
# Generated: $(date)
ROOT_PASSWORD='$NEW_PASSWORD'
PORT='$MYSQL_PORT'
SOCKET='$MYSQL_SOCKET'
EOF
chmod 600 "$CONF_FILE"

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "MariaDB instance password reset successfully!"
echo ""
echo "  Instance:    $instance"
echo "  Port:        $MYSQL_PORT"
echo "  Socket:      $MYSQL_SOCKET"
echo "  Password:    $NEW_PASSWORD"
echo "  Config:      $CONF_FILE"
echo ""

exit 0
