#!/bin/bash
# info: change mongodb database user password
# options: USER DATABASE DBUSER [DBPASSWORD]
#
# example: v-change-database-mongo-user-password admin myapp_db myapp_user newpassword123
#
# This function changes the password for a MongoDB database user.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
database=$2
dbuser=$3
dbpassword=$4

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source $HESTIA/func/mongodb.sh
source_conf "$HESTIA/conf/hestia.conf"

# Load MongoDB root password
if [ -f "$HESTIA/conf/mongodb.conf" ]; then
    source "$HESTIA/conf/mongodb.conf"
    export MONGODB_ROOT_PASSWORD="$ROOT_PASSWORD"
fi

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '3' "$#" 'USER DATABASE DBUSER [DBPASSWORD]'

# Check if MongoDB is installed
if [ "$MONGODB_SYSTEM" != "yes" ]; then
    echo "Error: MongoDB is not installed"
    exit 1
fi

# Validate Hestia user
is_object_valid 'user' 'USER' "$user"

# Generate password if not provided
if [ -z "$dbpassword" ]; then
    dbpassword=$(generate_mongodb_password 16)
fi

# Sanitize database name
if [[ ! "$database" =~ ^${user}_ ]]; then
    database="${user}_${database}"
fi

# Check if database exists
if ! is_mongodb_database_exists "$database"; then
    echo "Error: Database '$database' does not exist"
    exit 1
fi

# Check if user exists
if ! is_mongodb_user_exists "$dbuser" "$database"; then
    echo "Error: User '$dbuser' does not exist in database '$database'"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Changing password for MongoDB user: $dbuser..."

# Change password using MongoDB function
change_mongodb_password "$dbuser" "$dbpassword" "$database"

if [ $? -ne 0 ]; then
    echo "Error: Failed to change password"
    exit 1
fi

# Update config file
user_conf_dir="$HESTIA/data/users/$user"
mongo_users_file="$user_conf_dir/mongodb_users.conf"

if [ -f "$mongo_users_file" ]; then
    # Update password in config (format: database:user:password:role)
    old_line=$(grep "^${database}:${dbuser}:" "$mongo_users_file")
    if [ -n "$old_line" ]; then
        role=$(echo "$old_line" | cut -d':' -f4)
        sed -i "s|^${database}:${dbuser}:.*|${database}:${dbuser}:${dbpassword}:${role}|" "$mongo_users_file"
    fi
fi

# Log event
log_mongodb_event "INFO" "Password changed for user: $dbuser in database $database"

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "Password changed successfully!"
echo ""
echo "  Database:    $database"
echo "  User:        $dbuser"
echo "  Password:    $dbpassword"
echo ""
echo "  Connection String:"
echo "  $(get_mongodb_connection_string "$dbuser" "$dbpassword" "$database" "localhost" "27017")"
echo ""

# Logging
$HESTIA/bin/v-log-action "$user" "Info" "MongoDB" "Password changed for user $dbuser in database $database"

exit 0
