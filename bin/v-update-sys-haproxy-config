#!/bin/bash
# info: update HAProxy configuration
# options: CONFIG_FILE
#
# example: v-update-sys-haproxy-config /tmp/haproxy_config_temp
#
# This function updates HAProxy configuration and restarts the service

config_input=$1

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

# Check args
if [ -z "$config_input" ]; then
    echo "Error: Config file path required"
    exit 1
fi

# Check if input file exists
if [ ! -f "$config_input" ]; then
    echo "Error: Input config file not found: $config_input"
    exit 1
fi

# Check if HAProxy is installed
if [ ! -f "/etc/haproxy/haproxy.cfg" ]; then
    echo "Error: HAProxy is not installed"
    exit 1
fi

# Validate the new configuration
/usr/sbin/haproxy -c -f "$config_input" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Error: Invalid HAProxy configuration"
    exit 1
fi

# Backup current config
cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Apply new config
cp "$config_input" /etc/haproxy/haproxy.cfg
chmod 644 /etc/haproxy/haproxy.cfg

# Reload HAProxy - try multiple methods
if systemctl reload-or-restart haproxy 2>/dev/null; then
    echo "OK"
    $HESTIA/bin/v-log-action "system" "Info" "HAProxy" "Configuration updated" 2>/dev/null
    exit 0
fi

# Fallback: try restart
if systemctl restart haproxy 2>/dev/null; then
    echo "OK"
    $HESTIA/bin/v-log-action "system" "Info" "HAProxy" "Configuration updated" 2>/dev/null
    exit 0
fi

# Fallback: try service command
if service haproxy restart 2>/dev/null; then
    echo "OK"
    exit 0
fi

# If all failed, restore backup
cp /etc/haproxy/haproxy.cfg.bak /etc/haproxy/haproxy.cfg
systemctl restart haproxy 2>/dev/null
echo "Error: HAProxy failed to restart. Previous config restored."
exit 1
