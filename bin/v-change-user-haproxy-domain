#!/bin/bash
# info: change HAProxy domain settings for user
# options: USER DOMAIN BACKEND_HOST BACKEND_PORT [BACKEND_TYPE] [SSL_MODE] [ALIASES] [HEALTH_CHECK] [ENABLED]
#
# example: v-change-user-haproxy-domain admin example.com 127.0.0.1 3001 pm2 termination "www.example.com" yes yes
#
# This function updates an existing HAProxy domain configuration.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2
backend_host=$3
backend_port=$4
backend_type=${5:-pm2}
ssl_mode=${6:-termination}
aliases=${7:-}
health_check=${8:-yes}
enabled=${9:-yes}

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '4' "$#" 'USER DOMAIN BACKEND_HOST BACKEND_PORT [BACKEND_TYPE] [SSL_MODE] [ALIASES] [HEALTH_CHECK] [ENABLED]'
is_format_valid 'user' 'domain'
is_object_valid 'user' 'USER' "$user"

# Validate backend_port is numeric
if ! [[ "$backend_port" =~ ^[0-9]+$ ]]; then
    echo "Error: Backend port must be numeric"
    exit 1
fi

# Validate port range
if [ "$backend_port" -lt 1 ] || [ "$backend_port" -gt 65535 ]; then
    echo "Error: Backend port must be between 1 and 65535"
    exit 1
fi

# Validate backend_type
case "$backend_type" in
    pm2|static|php|nginx|custom) ;;
    *)
        echo "Error: Invalid backend type. Must be: pm2, static, php, nginx, or custom"
        exit 1
        ;;
esac

# Validate ssl_mode
case "$ssl_mode" in
    termination|passthrough|none) ;;
    *)
        echo "Error: Invalid SSL mode. Must be: termination, passthrough, or none"
        exit 1
        ;;
esac

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Define paths
HAPROXY_JSON="$HESTIA/data/users/$user/haproxy.json"
USER_HAPROXY_DIR="$HOMEDIR/$user/conf/haproxy"
BACKEND_DIR="$USER_HAPROXY_DIR/backends"
FRONTEND_DIR="$USER_HAPROXY_DIR/frontends"

# Check if haproxy.json exists
if [ ! -f "$HAPROXY_JSON" ]; then
    echo "Error: No HAProxy configuration found for user $user"
    exit 1
fi

# Check if domain exists in haproxy.json
if command -v jq &> /dev/null; then
    existing=$(jq -r ".domains[] | select(.domain == \"$domain\") | .domain" "$HAPROXY_JSON" 2>/dev/null)
    if [ -z "$existing" ]; then
        echo "Error: Domain $domain not found in HAProxy configuration"
        exit 1
    fi
else
    echo "Error: jq is required for JSON manipulation"
    exit 1
fi

# Generate backend name (sanitize domain for HAProxy identifier)
backend_name="${user}_$(echo "$domain" | tr '.' '_' | tr '-' '_')"

# Parse aliases into JSON array
aliases_json="[]"
if [ -n "$aliases" ]; then
    aliases_json=$(echo "$aliases" | tr ' ' '\n' | jq -R . | jq -s .)
fi

# Convert enabled to boolean
enabled_bool=$([ "$enabled" = "yes" ] && echo "true" || echo "false")
health_check_bool=$([ "$health_check" = "yes" ] && echo "true" || echo "false")

# Update domain in haproxy.json
jq "(.domains[] | select(.domain == \"$domain\")) |= . + {
    \"aliases\": $aliases_json,
    \"backend\": {
        \"name\": \"$backend_name\",
        \"host\": \"$backend_host\",
        \"port\": $backend_port,
        \"type\": \"$backend_type\"
    },
    \"ssl\": {
        \"mode\": \"$ssl_mode\",
        \"cert\": .ssl.cert
    },
    \"options\": {
        \"healthCheck\": $health_check_bool,
        \"customConfig\": .options.customConfig
    },
    \"enabled\": $enabled_bool
}" "$HAPROXY_JSON" > "$HAPROXY_JSON.tmp" && mv "$HAPROXY_JSON.tmp" "$HAPROXY_JSON"

# Regenerate backend config file
BACKEND_CFG="$BACKEND_DIR/${domain}.cfg"

cat > "$BACKEND_CFG" << EOF
# Domain: $domain
# User: $user
# Generated: $(date)
backend $backend_name
    mode http
    balance roundrobin

    # Forward original client info
    option forwardfor
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
    http-request set-header X-Forwarded-Host %[req.hdr(host)]
EOF

# Add health check if enabled
if [ "$health_check" = "yes" ]; then
    cat >> "$BACKEND_CFG" << EOF

    # Health check
    option httpchk GET /
    http-check expect status 200-499
EOF
fi

# Add server line
cat >> "$BACKEND_CFG" << EOF

    # Backend server
    server ${backend_type}_${backend_port} ${backend_host}:${backend_port}$([ "$health_check" = "yes" ] && echo " check inter 5s fall 3 rise 2")
EOF

chmod 644 "$BACKEND_CFG"

# Regenerate frontend config with all user domains
FRONTEND_CFG="$FRONTEND_DIR/${user}_domains.cfg"

{
    echo "# User: $user - HAProxy frontend rules"
    echo "# Generated: $(date)"
    echo "# DO NOT EDIT - Auto-generated by v-change-user-haproxy-domain"
    echo ""

    # Generate ACLs and use_backend rules for each domain
    jq -r '.domains[] | select(.enabled == true) | @json' "$HAPROXY_JSON" 2>/dev/null | while read -r domain_json; do
        d_domain=$(echo "$domain_json" | jq -r '.domain')
        d_aliases=$(echo "$domain_json" | jq -r '.aliases // [] | join(" ")')
        d_backend=$(echo "$domain_json" | jq -r '.backend.name')

        # ACL for main domain
        acl_name="host_${d_backend}"

        # Build ACL condition with domain and aliases
        acl_domains="$d_domain"
        if [ -n "$d_aliases" ] && [ "$d_aliases" != "null" ]; then
            acl_domains="$acl_domains $d_aliases"
        fi

        echo "acl $acl_name hdr(host) -i $acl_domains"
        echo "use_backend $d_backend if $acl_name"
        echo ""
    done
} > "$FRONTEND_CFG"

chmod 644 "$FRONTEND_CFG"

# Rebuild HAProxy configuration
$HESTIA/bin/v-rebuild-haproxy-conf yes

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

$HESTIA/bin/v-log-action "user" "Info" "HAProxy" "Updated HAProxy domain (User: $user, Domain: $domain, Backend: $backend_host:$backend_port)."

echo "HAProxy domain $domain updated successfully"
exit 0
