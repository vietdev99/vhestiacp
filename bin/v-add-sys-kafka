#!/bin/bash
# info: install Apache Kafka
# options: [KAFKA_UI]
#
# example: v-add-sys-kafka yes
#
# This function installs and configures Apache Kafka.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

kafka_ui=${1:-yes}

KAFKA_VERSION="3.9.0"
SCALA_VERSION="2.13"
KAFKA_HOME="/opt/kafka"

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if already installed
if [ -d "$KAFKA_HOME" ]; then
    echo "Kafka is already installed"
    exit 0
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "[ * ] Installing Apache Kafka..."

# Install Java (required for Kafka)
echo "    - Installing Java..."
apt-get update > /dev/null 2>&1
apt-get install -y openjdk-17-jre-headless > /dev/null 2>&1

# Create kafka user
if ! id "kafka" &>/dev/null; then
    useradd -r -s /sbin/nologin kafka
fi

# Download Kafka with retry and verification
echo "    - Downloading Kafka ${KAFKA_VERSION}..."
cd /tmp
rm -f kafka.tgz

# Primary download URL (CDN)
DOWNLOAD_URL="https://dlcdn.apache.org/kafka/${KAFKA_VERSION}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}.tgz"
echo "    - Trying: $DOWNLOAD_URL"
wget --timeout=60 -q "$DOWNLOAD_URL" -O kafka.tgz 2>/dev/null

# Verify download size (should be > 50MB)
if [ -f "kafka.tgz" ]; then
    FILE_SIZE=$(stat -f%z "kafka.tgz" 2>/dev/null || stat -c%s "kafka.tgz" 2>/dev/null)
    if [ "$FILE_SIZE" -lt 50000000 ]; then
        echo "    - Download incomplete (${FILE_SIZE} bytes), trying mirror..."
        rm -f kafka.tgz
    fi
fi

# Try Apache archive mirror if primary failed
if [ ! -f "kafka.tgz" ] || [ ! -s "kafka.tgz" ]; then
    MIRROR_URL="https://archive.apache.org/dist/kafka/${KAFKA_VERSION}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}.tgz"
    echo "    - Trying archive mirror: $MIRROR_URL"
    wget --timeout=120 -q "$MIRROR_URL" -O kafka.tgz 2>/dev/null
fi

# Final verification
if [ ! -f "kafka.tgz" ] || [ ! -s "kafka.tgz" ]; then
    echo "Error: Failed to download Kafka"
    exit 1
fi

# Verify file is valid gzip
if ! gzip -t kafka.tgz 2>/dev/null; then
    echo "Error: Downloaded file is corrupted"
    rm -f kafka.tgz
    exit 1
fi

echo "    - Extracting Kafka..."
# Extract and install
tar -xzf kafka.tgz
if [ $? -ne 0 ]; then
    echo "Error: Failed to extract Kafka"
    rm -f kafka.tgz
    exit 1
fi

mv "kafka_${SCALA_VERSION}-${KAFKA_VERSION}" "$KAFKA_HOME"
rm -f kafka.tgz

# Create directories
mkdir -p /var/lib/kafka/data
mkdir -p /var/log/kafka

# Set ownership
chown -R kafka:kafka "$KAFKA_HOME"
chown -R kafka:kafka /var/lib/kafka
chown -R kafka:kafka /var/log/kafka

# Generate cluster ID for KRaft mode
CLUSTER_ID=$($KAFKA_HOME/bin/kafka-storage.sh random-uuid)

# Create KRaft config (no Zookeeper needed)
echo "    - Configuring Kafka with KRaft mode..."
cat > "$KAFKA_HOME/config/kraft/server.properties" << EOF
# KRaft Server Configuration
# Generated by VHestiaCP

# Node settings
process.roles=broker,controller
node.id=1
controller.quorum.voters=1@localhost:9093
controller.listener.names=CONTROLLER

# Listeners
listeners=PLAINTEXT://:9092,CONTROLLER://:9093
advertised.listeners=PLAINTEXT://localhost:9092
inter.broker.listener.name=PLAINTEXT

# Log directories
log.dirs=/var/lib/kafka/data

# Log settings
num.partitions=1
default.replication.factor=1
min.insync.replicas=1

# Log retention
log.retention.hours=168
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000

# Other settings
offsets.topic.replication.factor=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1
EOF

# Format storage
echo "    - Formatting Kafka storage..."
$KAFKA_HOME/bin/kafka-storage.sh format -t "$CLUSTER_ID" -c "$KAFKA_HOME/config/kraft/server.properties" > /dev/null 2>&1
chown -R kafka:kafka /var/lib/kafka

# Create systemd service
cat > /etc/systemd/system/kafka.service << EOF
[Unit]
Description=Apache Kafka Server
Documentation=https://kafka.apache.org/documentation/
After=network.target

[Service]
Type=simple
User=kafka
Group=kafka
Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
Environment="KAFKA_HEAP_OPTS=-Xmx512M -Xms512M"
ExecStart=${KAFKA_HOME}/bin/kafka-server-start.sh ${KAFKA_HOME}/config/kraft/server.properties
ExecStop=${KAFKA_HOME}/bin/kafka-server-stop.sh
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# Start Kafka
systemctl daemon-reload
systemctl enable kafka > /dev/null 2>&1
systemctl start kafka

# Wait for Kafka to start
sleep 5

# Generate credentials for SASL (optional, for future use)
KAFKA_USER="admin"
KAFKA_PASSWORD=$(generate_password 16)

# Open firewall ports
if [ -x "$(command -v ufw)" ]; then
    ufw allow 9092/tcp comment "Kafka" > /dev/null 2>&1
fi
if [ -f "$HESTIA/bin/v-add-firewall-rule" ]; then
    $HESTIA/bin/v-add-firewall-rule ACCEPT 0.0.0.0/0 9092 TCP "Kafka" > /dev/null 2>&1
fi

# Install Kafka UI if requested
if [ "$kafka_ui" = "yes" ]; then
    echo "    - Installing Kafka UI..."
    
    # Download Kafka UI (using Docker-less JAR)
    KAFKA_UI_VERSION="0.7.2"
    mkdir -p /opt/kafka-ui
    
    wget -q "https://github.com/provectus/kafka-ui/releases/download/v${KAFKA_UI_VERSION}/kafka-ui-api-v${KAFKA_UI_VERSION}.jar" \
        -O /opt/kafka-ui/kafka-ui.jar 2>/dev/null
    
    if [ -f "/opt/kafka-ui/kafka-ui.jar" ]; then
        # Create config
        cat > /opt/kafka-ui/application.yml << EOF
kafka:
  clusters:
    - name: local
      bootstrapServers: localhost:9092

server:
  port: 8090

spring:
  security:
    user:
      name: ${KAFKA_USER}
      password: ${KAFKA_PASSWORD}
EOF
        
        # Create systemd service
        cat > /etc/systemd/system/kafka-ui.service << EOF
[Unit]
Description=Kafka UI
Documentation=https://github.com/provectus/kafka-ui
After=kafka.service
Requires=kafka.service

[Service]
Type=simple
User=kafka
Group=kafka
Environment="JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64"
WorkingDirectory=/opt/kafka-ui
ExecStart=/usr/bin/java -jar /opt/kafka-ui/kafka-ui.jar --spring.config.location=/opt/kafka-ui/application.yml
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
        
        chown -R kafka:kafka /opt/kafka-ui
        
        systemctl daemon-reload
        systemctl enable kafka-ui > /dev/null 2>&1
        systemctl start kafka-ui
        
        # Open firewall port
        if [ -x "$(command -v ufw)" ]; then
            ufw allow 8090/tcp comment "KafkaUI" > /dev/null 2>&1
        fi
        if [ -f "$HESTIA/bin/v-add-firewall-rule" ]; then
            $HESTIA/bin/v-add-firewall-rule ACCEPT 0.0.0.0/0 8090 TCP "KafkaUI" > /dev/null 2>&1
        fi
        
        echo "    ✓ Kafka UI installed on port 8090"
    else
        echo "    ✗ Failed to download Kafka UI"
        kafka_ui="no"
    fi
fi

# Save credentials to Hestia config
mkdir -p "$HESTIA/conf"
cat > "$HESTIA/conf/kafka.conf" << EOF
# Kafka Configuration
# Generated by VHestiaCP

KAFKA_VERSION='$KAFKA_VERSION'
KAFKA_HOME='$KAFKA_HOME'
KAFKA_HOST='localhost'
KAFKA_PORT='9092'
KAFKA_USER='$KAFKA_USER'
KAFKA_PASSWORD='$KAFKA_PASSWORD'
KAFKA_UI='$kafka_ui'
KAFKA_UI_PORT='8090'
CLUSTER_ID='$CLUSTER_ID'
EOF

chmod 640 "$HESTIA/conf/kafka.conf"

# Update hestia.conf
if ! grep -q "KAFKA_SYSTEM" "$HESTIA/conf/hestia.conf"; then
    echo "KAFKA_SYSTEM='yes'" >> "$HESTIA/conf/hestia.conf"
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo "    ✓ Apache Kafka installed successfully"
echo ""
echo "    Connection Details:"
echo "    ─────────────────────────────────"
echo "    Bootstrap Server: localhost:9092"
echo "    Cluster ID:       $CLUSTER_ID"
if [ "$kafka_ui" = "yes" ]; then
    echo ""
    echo "    Kafka UI:         http://localhost:8090"
    echo "    UI Username:      $KAFKA_USER"
    echo "    UI Password:      $KAFKA_PASSWORD"
fi
echo ""

# Logging
$HESTIA/bin/v-log-action "system" "Info" "Plugins" "Apache Kafka installed"

exit 0
