#!/bin/bash
# info: install PHP-FPM
# options: [VERSION]
#
# example: v-add-sys-phpfpm
# example: v-add-sys-phpfpm 8.3
#
# This function installs PHP-FPM (FastCGI Process Manager) on the system.
# If no version is specified, it will install the default PHP version.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
version=${1:-}

# Includes
# shellcheck source=/etc/vhestia/hestia.conf
source /etc/vhestia/hestia.conf
# shellcheck source=/usr/local/vhestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check root permissions
if [ "x$(id -u)" != 'x0' ]; then
    echo "Error: Script must be run as root"
    exit 1
fi

# Detect OS
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    VERSION_ID=$VERSION_ID
else
    echo "Error: Cannot detect OS"
    exit 1
fi

# Determine default PHP version based on OS
if [ -z "$version" ]; then
    case "$VERSION_ID" in
        "24.04") version="8.3" ;;
        "22.04") version="8.1" ;;
        "20.04") version="7.4" ;;
        *) version="8.3" ;;
    esac
fi

# Check if PHP-FPM is already installed and running
php_already_running=false
if systemctl is-active --quiet "php${version}-fpm" 2>/dev/null; then
    php_already_running=true
    echo "PHP-FPM $version is already installed and running"
fi

# Ensure WEB_BACKEND is configured (even if PHP-FPM was pre-installed)
# This fixes the issue where nginx uses wrong template when WEB_BACKEND is not set
if [ -z "$WEB_BACKEND" ]; then
    echo "WEB_BACKEND='php-fpm'" >> $HESTIA/conf/hestia.conf
    echo "Configured WEB_BACKEND='php-fpm'"
fi

# Set default PHP version if not set
if [ -z "$DEFAULT_PHP" ]; then
    echo "DEFAULT_PHP='$version'" >> $HESTIA/conf/hestia.conf
    echo "Configured DEFAULT_PHP='$version'"
fi

# Create PHP-FPM backend template if not exists
template_name="PHP-${version//./_}"  # 8.3 -> PHP-8_3
template_path="$HESTIA/data/templates/web/php-fpm/${template_name}.tpl"
if [ ! -f "$template_path" ]; then
    echo "Creating backend template: $template_name"
    # Use default multiphp template
    cat > "$template_path" << 'EOFTPL'
; origin-src: deb/php-fpm/multiphp.tpl
;#=========================================================================#
;# Default Web Domain Template                                             #
;# DO NOT MODIFY THIS FILE! CHANGES WILL BE LOST WHEN REBUILDING DOMAINS   #
;# https://hestiacp.com/docs/server-administration/web-templates.html      #
;#=========================================================================#

[%domain%]
listen = /run/php/php%backend_version%-fpm-%domain%.sock
listen.owner = %user%
listen.group = www-data
listen.mode = 0660

user = %user%
group = %user%

pm = ondemand
pm.max_children = 8
pm.max_requests = 4000
pm.process_idle_timeout = 10s
pm.status_path = /status

php_admin_value[upload_tmp_dir] = /home/%user%/tmp
php_admin_value[session.save_path] = /home/%user%/tmp
php_admin_value[open_basedir] = /home/%user%/.composer:/home/%user%/web/%domain%/public_html:/home/%user%/web/%domain%/private:/home/%user%/web/%domain%/public_shtml:/home/%user%/tmp:/tmp:/var/www/html:/bin:/usr/bin:/usr/local/bin:/usr/share:/opt
php_admin_value[sendmail_path] = /usr/sbin/sendmail -t -i -f admin@%domain%

env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /home/%user%/tmp
env[TMPDIR] = /home/%user%/tmp
env[TEMP] = /home/%user%/tmp
EOFTPL
fi

# Fix www.conf to use version-specific socket (avoid conflict between PHP versions)
www_conf="/etc/php/${version}/fpm/pool.d/www.conf"
if [ -f "$www_conf" ]; then
    current_socket=$(grep "^listen = " "$www_conf" | head -1)
    # If using generic socket path, change to version-specific
    if echo "$current_socket" | grep -q "/run/php/www.sock\|/run/php/php-fpm.sock"; then
        echo "Fixing www.conf socket path for PHP $version..."
        sed -i "s|listen = /run/php/www.sock|listen = /run/php/php${version}-fpm.sock|g" "$www_conf"
        sed -i "s|listen = /run/php/php-fpm.sock|listen = /run/php/php${version}-fpm.sock|g" "$www_conf"

        # Restart if already running to apply changes
        if [ "$php_already_running" = true ]; then
            echo "Restarting PHP-FPM $version to apply socket changes..."
            systemctl restart "php${version}-fpm"
        fi
    fi
fi

# Exit if already running (template has been created above)
if [ "$php_already_running" = true ]; then
    exit 0
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Installing PHP-FPM $version..."

# Add PHP repository if needed (for non-default versions)
if [ "$OS" = "ubuntu" ]; then
    # Check if ondrej/php PPA is added
    if ! grep -q "ondrej/php" /etc/apt/sources.list.d/*.list 2>/dev/null; then
        echo "Adding PHP repository..."
        apt-get -y install software-properties-common > /dev/null 2>&1
        add-apt-repository -y ppa:ondrej/php > /dev/null 2>&1
        apt-get -y update > /dev/null 2>&1
    fi
fi

# Install PHP-FPM and common extensions
echo "Installing PHP $version packages..."
apt-get -y install \
    php${version}-fpm \
    php${version}-common \
    php${version}-cli \
    php${version}-mysql \
    php${version}-curl \
    php${version}-gd \
    php${version}-mbstring \
    php${version}-xml \
    php${version}-zip \
    php${version}-intl \
    php${version}-bcmath \
    php${version}-soap \
    php${version}-opcache \
    > /dev/null 2>&1

if [ $? -ne 0 ]; then
    echo "Error: Failed to install PHP packages"
    exit 1
fi

# Start and enable PHP-FPM
echo "Starting PHP-FPM service..."
systemctl enable php${version}-fpm > /dev/null 2>&1
systemctl start php${version}-fpm

# Verify service is running
if ! systemctl is-active --quiet "php${version}-fpm"; then
    echo "Error: PHP-FPM failed to start"
    exit 1
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo "PHP-FPM $version installed successfully"
echo "  Service: php${version}-fpm"
echo "  Status: $(systemctl is-active php${version}-fpm)"

# Log action
$BIN/v-log-action "system" "Info" "System" "Installed PHP-FPM $version"

exit 0
