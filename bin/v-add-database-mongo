#!/bin/bash
# info: add mongodb database
# options: USER DATABASE [DBPASSWORD] [INSTANCE]
#
# example: v-add-database-mongo admin myapp_db password123 vtest2
#
# This function creates a new MongoDB database and user.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
database=$2
dbpassword=$3
instance=${4:-default}

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source $HESTIA/func/mongodb.sh
source_conf "$HESTIA/conf/hestia.conf"

# Determine MongoDB port based on instance
MONGODB_PORT=27017
MONGODB_SERVICE="mongod"
MONGODB_HOST="127.0.0.1"

if [ "$instance" != "default" ]; then
    # Load instance config from JSON
    instance_file="$HESTIA/data/mongodb-instances.json"
    if [ -f "$instance_file" ] && command -v jq &>/dev/null; then
        inst_port=$(jq -r ".instances[] | select(.name==\"$instance\") | .port" "$instance_file" 2>/dev/null)
        if [ -n "$inst_port" ] && [ "$inst_port" != "null" ]; then
            MONGODB_PORT="$inst_port"
        fi
        MONGODB_SERVICE="mongod-$instance"
    fi
fi

# Export port for mongodb.sh functions
export MONGODB_PORT
export MONGODB_HOST
export MONGODB_INSTANCE="$instance"

# Load MongoDB root password
if [ -f "$HESTIA/conf/mongodb.conf" ]; then
    source "$HESTIA/conf/mongodb.conf"
    export MONGODB_ROOT_PASSWORD="$ROOT_PASSWORD"
fi

# Set dbuser to same as database
dbuser="${user}_${database}"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER DATABASE [DBPASSWORD] [INSTANCE]'

# Check if MongoDB is installed
if [ "$MONGODB_SYSTEM" != "yes" ]; then
    echo "Error: MongoDB is not installed"
    exit 1
fi

# Validate user
is_object_valid 'user' 'USER' "$user"

# Generate password if not provided
if [ -z "$dbpassword" ]; then
    dbpassword=$(generate_mongodb_password 16)
fi

# Sanitize database name (prepend username)
if [[ ! "$database" =~ ^${user}_ ]]; then
    database="${user}_${database}"
    dbuser="${user}_$(echo ${2} | sed "s/^${user}_//")"
fi

# Check if database already exists
if is_mongodb_database_exists "$database"; then
    echo "Error: Database '$database' already exists"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Creating MongoDB database: $database on instance: $instance (port $MONGODB_PORT)..."

# Debug: Check MongoDB instance status
if ! systemctl is-active --quiet $MONGODB_SERVICE; then
    echo "Error: MongoDB service '$MONGODB_SERVICE' is not running"
    echo "Try: sudo systemctl start $MONGODB_SERVICE"
    exit 1
fi

# Debug: Check if mongosh is available
if ! command -v mongosh &>/dev/null && ! command -v mongo &>/dev/null; then
    echo "Error: MongoDB shell (mongosh/mongo) not found"
    exit 1
fi

# Create database
result=$(create_mongodb_database "$database" 2>&1)
exit_code=$?

if [ $exit_code -ne 0 ]; then
    echo "Error: Failed to create database"
    echo "Details: $result"
    echo ""
    echo "Debug info:"
    echo "  - Instance: $instance"
    echo "  - Port: $MONGODB_PORT"
    echo "  - Service: $MONGODB_SERVICE"
    echo "  - MongoDB status: $(systemctl is-active $MONGODB_SERVICE)"
    
    # Check for auth issues
    if echo "$result" | grep -qi "auth\|unauthorized\|Authentication"; then
        echo ""
        echo ">>> Authentication failed! Check the MongoDB password."
    fi
    
    # Check for replicaset issues  
    if echo "$result" | grep -qi "primary\|recovering\|replicaset"; then
        echo ""
        echo ">>> ReplicaSet issue detected. Instance may not be primary or properly initialized."
        echo ">>> If this is a standalone instance, ensure replication is disabled in config."
    fi
    exit 1
fi

# Create user
echo "Creating database user: $dbuser..."
create_mongodb_user "$dbuser" "$dbpassword" "$database" "readWrite"
if [ $? -ne 0 ]; then
    echo "Warning: Failed to create user, but database was created"
fi

# Store database info in user's config
echo "Storing database info..."
user_dir="$HESTIA/data/users/$user"
user_db_conf="$user_dir/mongodb.conf"

# Create directory if not exists
mkdir -p "$user_dir"

# Create file if not exists
touch "$user_db_conf"

# Remove existing entry if any
sed -i "/^DB='$database'/d" "$user_db_conf" 2>/dev/null || true

# Add new entry with date and instance
echo "DB='$database' USER='$dbuser' PASSWORD='$dbpassword' HOST='$MONGODB_HOST' PORT='$MONGODB_PORT' INSTANCE='$instance' DATE='$(date +%Y-%m-%d)' TYPE='mongodb'" >> "$user_db_conf"
echo "  - Database info stored in $user_db_conf"

# Note: store_mongodb_user_db removed - it doesn't save INSTANCE field and overwrites the entry above
# if type store_mongodb_user_db &>/dev/null; then
#     store_mongodb_user_db "$user" "$database" "$dbuser" "$dbpassword" "$MONGODB_HOST" 2>/dev/null || true
# fi

# Log event
log_mongodb_event "INFO" "Database created: $database (user: $user, instance: $instance)" 2>/dev/null || true

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "MongoDB database created successfully!"
echo ""
echo "  Database:    $database"
echo "  User:        $dbuser"
echo "  Password:    $dbpassword"
echo "  Instance:    $instance"
echo "  Host:        $MONGODB_HOST"
echo "  Port:        $MONGODB_PORT"
echo ""
echo "  Connection String:"
echo "  $(get_mongodb_connection_string "$dbuser" "$dbpassword" "$database" "$MONGODB_HOST" "$MONGODB_PORT")"
echo ""

# Logging
$HESTIA/bin/v-log-action "$user" "Info" "MongoDB" "Database $database created on instance $instance"

exit 0
