#!/bin/bash
# info: list PHP extensions (installed and available)
# options: [PHP_VERSION] [FORMAT]
#
# example: v-list-php-extensions 8.3 json
#
# This function lists installed and available PHP extensions for a given PHP version.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

php_version=${1:-}
format=${2:-shell}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Auto-detect PHP version if not provided
if [ -z "$php_version" ]; then
    php_version=$(php -v 2>/dev/null | head -1 | grep -oP '\d+\.\d+' | head -1)
    if [ -z "$php_version" ]; then
        echo "Error: Could not detect PHP version"
        exit 1
    fi
fi

# Validate PHP version format
if ! [[ "$php_version" =~ ^[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Invalid PHP version format. Use X.Y (e.g., 8.3)"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Get available extensions from apt
available_packages=$(apt-cache search "php${php_version}-" 2>/dev/null | grep -E "^php${php_version}-" | awk '{print $1}' | sort -u)

# Common/popular extensions to highlight
popular_extensions="redis mongodb memcached imagick gd curl mbstring xml json mysql pgsql sqlite3 zip bcmath gmp intl soap ldap imap opcache apcu xdebug phalcon"

if [ "$format" = "json" ]; then
    echo "{"
    echo "  \"php_version\": \"$php_version\","
    echo "  \"extensions\": ["

    first=true
    for pkg in $available_packages; do
        # Extract extension name from package name (php8.3-redis -> redis)
        ext_name=$(echo "$pkg" | sed "s/php${php_version}-//")

        # Skip meta packages
        if [[ "$ext_name" =~ ^(cli|fpm|cgi|common|dev|phpdbg)$ ]]; then
            continue
        fi

        # Check if installed - use dpkg to check package status
        is_installed="false"
        if dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"; then
            is_installed="true"
        fi

        # Check if popular
        is_popular="false"
        echo "$popular_extensions" | grep -qw "$ext_name" && is_popular="true"

        # Get description
        description=$(apt-cache show "$pkg" 2>/dev/null | grep "^Description:" | head -1 | sed 's/Description: //' | sed 's/"/\\"/g')

        if [ "$first" = true ]; then
            first=false
        else
            echo ","
        fi

        printf '    {"name": "%s", "package": "%s", "installed": %s, "popular": %s, "description": "%s"}' \
            "$ext_name" "$pkg" "$is_installed" "$is_popular" "$description"
    done

    echo ""
    echo "  ]"
    echo "}"
else
    # Shell format
    echo "PHP Version: $php_version"
    echo ""
    echo "EXTENSION       PACKAGE                 STATUS      DESCRIPTION"
    echo "--------------------------------------------------------------------------"

    for pkg in $available_packages; do
        ext_name=$(echo "$pkg" | sed "s/php${php_version}-//")

        # Skip meta packages
        if [[ "$ext_name" =~ ^(cli|fpm|cgi|common|dev|phpdbg)$ ]]; then
            continue
        fi

        # Check if installed - use dpkg to check package status
        status="available"
        if dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"; then
            status="installed"
        fi

        description=$(apt-cache show "$pkg" 2>/dev/null | grep "^Description:" | head -1 | sed 's/Description: //' | cut -c1-40)

        printf "%-15s %-23s %-11s %s\n" "$ext_name" "$pkg" "$status" "$description"
    done
fi

exit 0
