#!/bin/bash
# info: list mongodb databases for a user
# options: USER [FORMAT]
#
# example: v-list-database-mongo admin
# example: v-list-database-mongo admin json

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

user=$1
format=${2:-plain}

HESTIA="${HESTIA:-/usr/local/hestia}"

# Source configs
if [ -f "$HESTIA/conf/hestia.conf" ]; then
    source "$HESTIA/conf/hestia.conf" 2>/dev/null
fi

if [ -f "$HESTIA/conf/mongodb.conf" ]; then
    source "$HESTIA/conf/mongodb.conf" 2>/dev/null
fi

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if MongoDB is installed
if [ "$MONGODB_SYSTEM" != "yes" ]; then
    [ "$format" = "json" ] && echo "{}" || echo "MongoDB not installed"
    exit 0
fi

# Check user argument
if [ -z "$user" ]; then
    [ "$format" = "json" ] && echo "{}" || echo "Error: User not specified"
    exit 0
fi

# Check MongoDB password
if [ -z "$ROOT_PASSWORD" ]; then
    [ "$format" = "json" ] && echo "{}" || echo "Error: MongoDB password not found"
    exit 0
fi

# Detect mongo shell
MONGO_SHELL=""
if command -v mongosh &>/dev/null; then
    MONGO_SHELL="mongosh"
elif command -v mongo &>/dev/null; then
    MONGO_SHELL="mongo"
else
    [ "$format" = "json" ] && echo "{}" || echo "Error: MongoDB shell not found"
    exit 0
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

if [ "$format" = "json" ]; then
    # Get databases - filter out warnings and "switched to" messages
    result=$($MONGO_SHELL --quiet -u admin -p "$ROOT_PASSWORD" --authenticationDatabase admin --eval "
        db.adminCommand('listDatabases').databases.forEach(function(d) {
            if (d.name.startsWith('${user}_')) {
                print(d.name + ':' + d.sizeOnDisk);
            }
        })
    " 2>/dev/null | grep -v "^Warning" | grep -v "^switched" | grep -v "^Using" | sort -u)
    
    # Build JSON output
    output="{"
    first=true
    
    while IFS=':' read -r db_name size; do
        [ -z "$db_name" ] && continue
        
        # Skip if db_name contains unwanted text
        [[ "$db_name" == *"Warning"* ]] && continue
        [[ "$db_name" == *"switched"* ]] && continue
        
        # Get collection count
        collections=$($MONGO_SHELL --quiet -u admin -p "$ROOT_PASSWORD" --authenticationDatabase admin --eval "print(db.getSiblingDB('$db_name').getCollectionNames().length)" 2>/dev/null | grep -oE '^[0-9]+' | head -1)
        collections=${collections:-0}
        
        # Get user count
        users=$($MONGO_SHELL --quiet -u admin -p "$ROOT_PASSWORD" --authenticationDatabase admin --eval "print(db.getSiblingDB('$db_name').getUsers().users.length)" 2>/dev/null | grep -oE '^[0-9]+' | head -1)
        users=${users:-0}
        
        # Add comma if not first
        [ "$first" = "false" ] && output+=","
        first=false
        
        # Add database entry
        output+="\"$db_name\":{\"COLLECTIONS\":$collections,\"USERS\":$users,\"SIZE\":${size:-0},\"DATE\":\"$(date +%Y-%m-%d)\"}"
    done <<< "$result"
    
    output+="}"
    echo "$output"
else
    # Plain text output
    echo ""
    echo "MongoDB Databases for: $user"
    echo "================================"
    
    $MONGO_SHELL --quiet -u admin -p "$ROOT_PASSWORD" --authenticationDatabase admin --eval "
        db.adminCommand('listDatabases').databases.forEach(function(d) {
            if (d.name.startsWith('${user}_')) {
                print('  - ' + d.name + ' (' + d.sizeOnDisk + ' bytes)');
            }
        })
    " 2>/dev/null | grep -v "^Warning" | grep -v "^switched"
    
    echo ""
fi

exit 0
