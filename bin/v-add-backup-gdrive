#!/bin/bash
# info: configure Google Drive backup using rclone
# options: REMOTE_NAME [FOLDER_ID]
#
# example: v-add-backup-gdrive gdrive
# example: v-add-backup-gdrive gdrive 1ABC123xyz
#
# This script helps configure Google Drive as a backup destination using rclone.
# It can use either interactive OAuth or a service account.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
remote_name=${1:-gdrive}
folder_id=$2

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if rclone is installed
if ! command -v rclone &> /dev/null; then
    echo "Error: rclone is not installed"
    echo "Install with: curl https://rclone.org/install.sh | sudo bash"
    exit 1
fi

# Perform verification if read-only mode is enabled
check_hestia_demo_mode

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Check if remote already exists
if rclone listremotes | grep -q "^${remote_name}:$"; then
    echo "Remote '$remote_name' already exists."
    echo ""
    echo "Current remotes:"
    rclone listremotes
    echo ""
    read -p "Do you want to reconfigure it? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        exit 0
    fi
    # Delete existing remote
    rclone config delete "$remote_name"
fi

echo ""
echo "=========================================="
echo "  Google Drive Backup Configuration"
echo "=========================================="
echo ""
echo "Choose authentication method:"
echo "  1) Interactive OAuth (requires browser access)"
echo "  2) Service Account (for headless servers)"
echo "  3) Use existing rclone config from another machine"
echo ""
read -p "Select option [1-3]: " auth_method

case $auth_method in
    1)
        echo ""
        echo "Starting interactive OAuth configuration..."
        echo ""
        echo "If this is a headless server, you'll need to:"
        echo "  1. Run 'rclone authorize drive' on a machine with a browser"
        echo "  2. Copy the token and paste it when prompted"
        echo ""

        # Create rclone config interactively
        rclone config create "$remote_name" drive \
            scope drive \
            ${folder_id:+root_folder_id $folder_id}
        ;;
    2)
        echo ""
        echo "Service Account Configuration"
        echo ""
        echo "You need a Google Cloud service account JSON key file."
        echo "See: https://rclone.org/drive/#service-account-support"
        echo ""
        read -p "Path to service account JSON file: " sa_file

        if [ ! -f "$sa_file" ]; then
            echo "Error: File not found: $sa_file"
            exit 1
        fi

        # Copy service account file to secure location
        mkdir -p /root/.config/rclone
        cp "$sa_file" "/root/.config/rclone/${remote_name}_sa.json"
        chmod 600 "/root/.config/rclone/${remote_name}_sa.json"

        # Create rclone config with service account
        rclone config create "$remote_name" drive \
            scope drive \
            service_account_file "/root/.config/rclone/${remote_name}_sa.json" \
            ${folder_id:+root_folder_id $folder_id}
        ;;
    3)
        echo ""
        echo "Manual Token Configuration"
        echo ""
        echo "On a machine with a browser, run:"
        echo "  rclone authorize drive"
        echo ""
        echo "Then paste the token JSON (starts with {\"access_token\":...)"
        echo ""
        read -p "Paste token: " token

        # Create rclone config with token
        rclone config create "$remote_name" drive \
            scope drive \
            token "$token" \
            ${folder_id:+root_folder_id $folder_id}
        ;;
    *)
        echo "Invalid option"
        exit 1
        ;;
esac

# Verify connection
echo ""
echo "Testing connection..."
if rclone lsd "${remote_name}:" &>/dev/null; then
    echo "✓ Successfully connected to Google Drive!"
    echo ""

    # Create backup folder
    backup_folder="hestia-backups"
    echo "Creating backup folder: $backup_folder"
    rclone mkdir "${remote_name}:${backup_folder}" 2>/dev/null

    # Add to HestiaCP backup
    echo ""
    echo "Configuring HestiaCP backup..."
    $HESTIA/bin/v-add-backup-host rclone "${remote_name}" "/${backup_folder}"

    echo ""
    echo "=========================================="
    echo "  Configuration Complete!"
    echo "=========================================="
    echo ""
    echo "Remote name: $remote_name"
    echo "Backup path: /${backup_folder}"
    echo ""
    echo "You can now:"
    echo "  - Run manual backup: v-backup-user admin"
    echo "  - Configure backup schedule in HestiaCP panel"
    echo "  - List remote files: rclone ls ${remote_name}:${backup_folder}"
    echo ""
else
    echo "✗ Failed to connect to Google Drive"
    echo "Please check your configuration"
    exit 1
fi

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

# Logging
log_event "$OK" "$ARGUMENTS"

exit 0
