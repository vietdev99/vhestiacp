#!/bin/bash
# info: delete HAProxy backend for user
# options: USER NAME
#
# example: v-delete-user-haproxy-backend admin myapp
#
# This function deletes a HAProxy backend configuration for a user.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
name=$2

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER NAME'
is_format_valid 'user' 'name'
is_object_valid 'user' 'USER' "$user"

# Check if backend exists
haproxy_conf="$HESTIA/data/users/$user/haproxy.conf"
if [ ! -f "$haproxy_conf" ]; then
    echo "Error: No HAProxy backends configured for user $user"
    exit 1
fi

if ! grep -q "NAME='$name'" "$haproxy_conf"; then
    echo "Error: Backend '$name' not found for user $user"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Get frontend port before deletion
frontend_port=$(grep "NAME='$name'" "$haproxy_conf" | grep -oP "FRONTEND_PORT='\K[^']+")

# Remove backend config file
backend_cfg="$HOMEDIR/$user/conf/haproxy/backends/${name}.cfg"
if [ -f "$backend_cfg" ]; then
    rm -f "$backend_cfg"
fi

# Remove from user's haproxy.conf
sed -i "/NAME='$name'/d" "$haproxy_conf"

# Remove from port allocation
if [ -n "$frontend_port" ]; then
    sed -i "/${user}:${name}:${frontend_port}/d" "$HESTIA/data/haproxy_user_ports.conf"
fi

# Rebuild main HAProxy config
$BIN/v-rebuild-haproxy-conf

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

$BIN/v-log-action "$user" "Info" "HAProxy" "Deleted backend $name"

echo "Backend '$name' deleted successfully"

exit 0
