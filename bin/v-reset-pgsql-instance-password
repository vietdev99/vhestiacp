#!/bin/bash
# info: reset/create postgres password for pgsql instance
# options: INSTANCE
#
# example: v-reset-pgsql-instance-password ptest2
#
# This function resets or creates postgres password for a PostgreSQL instance.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

instance=${1:-default}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

if [ -z "$instance" ]; then
    echo "Error: Instance name is required"
    exit 1
fi

#----------------------------------------------------------#
#                  Instance Configuration                  #
#----------------------------------------------------------#

PGSQL_PORT=5432

if [ "$instance" != "default" ]; then
    # Load instance config from JSON
    instance_file="$HESTIA/data/pgsql-instances.json"
    if [ -f "$instance_file" ] && command -v jq &>/dev/null; then
        inst_port=$(jq -r ".instances[] | select(.name==\"$instance\") | .port" "$instance_file" 2>/dev/null)
        [ -n "$inst_port" ] && [ "$inst_port" != "null" ] && PGSQL_PORT="$inst_port"
    fi
fi

# Check if PostgreSQL is running on this port
if ! sudo -u postgres psql -p $PGSQL_PORT -c "SELECT 1;" &>/dev/null; then
    echo "Error: Cannot connect to PostgreSQL on port $PGSQL_PORT"
    echo "Is the instance running?"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Resetting postgres password for PostgreSQL instance: $instance..."

# Generate new password
NEW_PASSWORD=$(< /dev/urandom tr -dc 'A-Za-z0-9' | head -c 20)

# Reset postgres user password
sudo -u postgres psql -p $PGSQL_PORT -c "ALTER USER postgres WITH PASSWORD '$NEW_PASSWORD';"
if [ $? -ne 0 ]; then
    echo "Error: Failed to reset password"
    exit 1
fi

# Save password to config
CONF_DIR="$HESTIA/conf"
mkdir -p "$CONF_DIR"

CONF_FILE="$CONF_DIR/pgsql-${instance}.conf"
cat > "$CONF_FILE" <<EOF
# PostgreSQL instance: $instance
# Generated: $(date)
ROOT_PASSWORD='$NEW_PASSWORD'
PORT='$PGSQL_PORT'
EOF
chmod 600 "$CONF_FILE"

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "PostgreSQL instance password reset successfully!"
echo ""
echo "  Instance:    $instance"
echo "  Port:        $PGSQL_PORT"
echo "  Config:      $CONF_FILE"
echo ""
echo "Password saved to: $CONF_FILE"

exit 0
