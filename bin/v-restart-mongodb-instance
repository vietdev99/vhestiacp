#!/bin/bash
# info: restart mongodb instance
# options: INSTANCE_NAME
#
# example: v-restart-mongodb-instance my-prod-db
#
# This function restarts a MongoDB instance.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

instance_name=$1

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

if [ -z "$instance_name" ]; then
    echo "Error: Instance name is required"
    echo "Usage: v-restart-mongodb-instance INSTANCE_NAME"
    exit 1
fi

service_name="mongod-${instance_name}"

if ! systemctl list-unit-files | grep -q "$service_name"; then
    echo "Error: Instance '$instance_name' does not exist"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Restarting MongoDB instance: $instance_name"
systemctl restart "$service_name"

sleep 3

if systemctl is-active --quiet "$service_name"; then
    echo "  ✅ Instance restarted successfully"
    $HESTIA/bin/v-log-action "system" "Info" "MongoDB" "Instance '$instance_name' restarted"
    exit 0
else
    echo "  ❌ Failed to restart instance"
    systemctl status "$service_name" --no-pager || true
    exit 1
fi
