#!/bin/bash
# info: install Redis in-memory cache
# options: NONE
#
# example: v-add-sys-redis
#
# This function installs and configures Redis server.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if already installed
if systemctl is-active --quiet redis-server 2>/dev/null; then
    echo "Redis is already installed and running"
    exit 0
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "[ * ] Installing Redis..."

# Install Redis
apt-get update > /dev/null 2>&1
apt-get install -y redis-server > /dev/null 2>&1

if [ $? -ne 0 ]; then
    echo "Error: Failed to install Redis"
    exit 1
fi

# Generate password
REDIS_PASSWORD=$(generate_password 32)

# Configure Redis
REDIS_CONF="/etc/redis/redis.conf"

# Backup original config
cp "$REDIS_CONF" "${REDIS_CONF}.bak"

# Basic security configuration
sed -i "s/^# requirepass .*/requirepass $REDIS_PASSWORD/" "$REDIS_CONF"
sed -i "s/^requirepass .*/requirepass $REDIS_PASSWORD/" "$REDIS_CONF"

# If requirepass doesn't exist, add it
if ! grep -q "^requirepass" "$REDIS_CONF"; then
    echo "requirepass $REDIS_PASSWORD" >> "$REDIS_CONF"
fi

# Bind to localhost only by default (security)
sed -i "s/^bind .*/bind 127.0.0.1 ::1/" "$REDIS_CONF"

# Enable persistence
sed -i "s/^# appendonly .*/appendonly yes/" "$REDIS_CONF"
sed -i "s/^appendonly no/appendonly yes/" "$REDIS_CONF"

# Set max memory (256MB default)
if ! grep -q "^maxmemory " "$REDIS_CONF"; then
    echo "maxmemory 256mb" >> "$REDIS_CONF"
    echo "maxmemory-policy allkeys-lru" >> "$REDIS_CONF"
fi

# Start and enable service
systemctl enable redis-server > /dev/null 2>&1
systemctl restart redis-server > /dev/null 2>&1

# Wait for Redis to start
sleep 2

# Verify Redis is running
if ! systemctl is-active --quiet redis-server; then
    echo "Error: Redis failed to start"
    exit 1
fi

# Test connection
if ! redis-cli -a "$REDIS_PASSWORD" ping 2>/dev/null | grep -q "PONG"; then
    echo "Warning: Redis is running but ping test failed"
fi

# Save credentials to Hestia config
mkdir -p "$HESTIA/conf"
cat > "$HESTIA/conf/redis.conf" << EOF
# Redis Configuration
# Generated by VHestiaCP

REDIS_HOST='127.0.0.1'
REDIS_PORT='6379'
REDIS_PASSWORD='$REDIS_PASSWORD'
EOF

chmod 640 "$HESTIA/conf/redis.conf"

# Update hestia.conf
if ! grep -q "REDIS_SYSTEM" "$HESTIA/conf/hestia.conf"; then
    echo "REDIS_SYSTEM='yes'" >> "$HESTIA/conf/hestia.conf"
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo "    ✓ Redis installed successfully"
echo ""
echo "    Connection Details:"
echo "    ─────────────────────────────────"
echo "    Host:     127.0.0.1"
echo "    Port:     6379"
echo "    Password: $REDIS_PASSWORD"
echo ""
echo "    Config:   /etc/redis/redis.conf"
echo ""

# Logging
$HESTIA/bin/v-log-action "system" "Info" "Plugins" "Redis in-memory cache installed"

exit 0
