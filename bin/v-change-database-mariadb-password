#!/bin/bash
# info: change database password on mariadb instance
# options: USER DATABASE DBUSER PASSWORD INSTANCE
#
# example: v-change-database-mariadb-password admin admin_mydb admin_myuser newpass123 btest1
#
# This function changes a database user password on a specific MariaDB instance.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

user=$1
database=$2
dbuser=$3
password=$4
instance=${5:-default}

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '4' "$#" 'USER DATABASE DBUSER PASSWORD [INSTANCE]'
is_object_valid 'user' 'USER' "$user"

if [ -z "$password" ]; then
    echo "Error: Password is required"
    exit 1
fi

#----------------------------------------------------------#
#                  Instance Configuration                  #
#----------------------------------------------------------#

MYSQL_PORT=3306
MYSQL_SOCKET="/var/run/mysqld/mysqld.sock"

if [ "$instance" != "default" ]; then
    if [ -f "/etc/mysql-instances/${instance}.cnf" ]; then
        MYSQL_PORT=$(grep -E "^port\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
        MYSQL_SOCKET=$(grep -E "^socket\s*=" "/etc/mysql-instances/${instance}.cnf" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
    else
        echo "Error: Instance config not found: /etc/mysql-instances/${instance}.cnf"
        exit 1
    fi
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Changing password for user: $dbuser on instance: $instance..."

# Build mysql command
mysql_cmd=""

# 1. Try instance-specific config first
INSTANCE_CONF="$HESTIA/conf/mariadb-${instance}.conf"
if [ -f "$INSTANCE_CONF" ]; then
    source "$INSTANCE_CONF"
    if [ -n "$ROOT_PASSWORD" ]; then
        mysql_cmd="mysql --socket=$MYSQL_SOCKET -u root -p$ROOT_PASSWORD"
    fi
fi

# 2. Try unix socket auth (no password, skip .my.cnf)
if [ -z "$mysql_cmd" ]; then
    if echo "SELECT 1;" | mysql --no-defaults --socket="$MYSQL_SOCKET" -u root &>/dev/null; then
        mysql_cmd="mysql --no-defaults --socket=$MYSQL_SOCKET -u root"
    fi
fi

# 3. Try /root/.my.cnf password (for default instance only)
if [ -z "$mysql_cmd" ] && [ "$instance" = "default" ] && [ -f "/root/.my.cnf" ]; then
    MYSQL_ROOT_PASSWORD=$(grep -E "^password\s*=" /root/.my.cnf | head -1 | cut -d'=' -f2 | tr -d ' \"')
    if [ -n "$MYSQL_ROOT_PASSWORD" ]; then
        mysql_cmd="mysql --socket=$MYSQL_SOCKET -u root -p$MYSQL_ROOT_PASSWORD"
    fi
fi

# 4. Fallback to no password with --no-defaults
if [ -z "$mysql_cmd" ]; then
    mysql_cmd="mysql --no-defaults --socket=$MYSQL_SOCKET -u root"
fi

# Change password
$mysql_cmd <<EOF
CREATE OR REPLACE USER '$dbuser'@'localhost' IDENTIFIED BY '$password';
FLUSH PRIVILEGES;
EOF

if [ $? -ne 0 ]; then
    echo "Error: Failed to change password"
    exit 1
fi

# Update password in user's config
user_dir="$HESTIA/data/users/$user"
user_db_conf="$user_dir/mariadb.conf"

if [ -f "$user_db_conf" ]; then
    # Update PASSWORD field for this database
    sed -i "s/\(DB='$database'.*PASSWORD='\)[^']*'/\1$password'/" "$user_db_conf"
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "Password changed successfully!"
echo ""
echo "  Database:  $database"
echo "  User:      $dbuser"
echo "  Instance:  $instance"
echo ""

exit 0
