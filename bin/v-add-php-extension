#!/bin/bash
# info: install PHP extension
# options: EXTENSION [PHP_VERSION]
#
# example: v-add-php-extension redis 8.3
#
# This function installs a PHP extension for a given PHP version.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

extension=$1
php_version=${2:-}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'EXTENSION [PHP_VERSION]'

# Auto-detect PHP version if not provided
if [ -z "$php_version" ]; then
    php_version=$(php -v 2>/dev/null | head -1 | grep -oP '\d+\.\d+' | head -1)
    if [ -z "$php_version" ]; then
        echo "Error: Could not detect PHP version"
        exit 1
    fi
fi

# Validate PHP version format
if ! [[ "$php_version" =~ ^[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Invalid PHP version format. Use X.Y (e.g., 8.3)"
    exit 1
fi

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

package="php${php_version}-${extension}"

echo "Installing PHP extension: $extension for PHP $php_version..."

# Check if package exists
if ! apt-cache show "$package" &>/dev/null; then
    echo "Error: Package $package not found"
    echo "Available extensions can be listed with: v-list-php-extensions $php_version"
    exit 1
fi

# Check if already installed
if dpkg -l | grep -q "^ii.*$package"; then
    echo "Extension $extension is already installed for PHP $php_version"
    exit 0
fi

# Wait for apt lock to be released (max 60 seconds)
wait_for_apt() {
    local max_wait=60
    local waited=0
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
          fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
        if [ $waited -ge $max_wait ]; then
            echo "Error: apt is locked. Please wait for other package operations to complete."
            exit 1
        fi
        echo "Waiting for apt lock... ($waited/$max_wait seconds)"
        sleep 2
        waited=$((waited + 2))
    done
}

# Wait for apt lock before proceeding
wait_for_apt

# Install the package
export DEBIAN_FRONTEND=noninteractive
apt-get update -qq
wait_for_apt
apt-get install -y "$package" 2>&1 || true

# Verify installation by checking dpkg status (apt may return error due to unrelated package issues)
if ! dpkg -l "$package" 2>/dev/null | grep -q "^ii"; then
    echo "Error: Failed to install $package"
    exit 1
fi

# Restart PHP-FPM if running
fpm_service="php${php_version}-fpm"
if systemctl is-active --quiet "$fpm_service"; then
    echo "Restarting $fpm_service..."
    systemctl restart "$fpm_service"
fi

echo "PHP extension $extension installed successfully for PHP $php_version"

#----------------------------------------------------------#
#                       Logging                            #
#----------------------------------------------------------#

$BIN/v-log-action "system" "Info" "PHP" "Extension $extension installed for PHP $php_version"
log_event "$OK" "$ARGUMENTS"

exit 0
