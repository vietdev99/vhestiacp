#!/bin/bash
# info: stop nodejs application for domain
# options: USER DOMAIN
#
# example: v-stop-web-domain-nodejs admin example.com
#
# This function stops the Node.js application for a domain.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

user=$1
domain=$2

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source $HESTIA/func/nodejs.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER DOMAIN'
is_object_valid 'user' 'USER' "$user"
is_object_valid 'web' 'DOMAIN' "$domain"

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Stopping Node.js application for $domain..."

load_nvm
stop_nodejs_app "$user" "$domain"

# Update status
user_conf="$HESTIA/data/users/$user/web.conf"
sed -i "/^DOMAIN='$domain'/ s/NODEJS_STATUS='[^']*'/NODEJS_STATUS='stopped'/" "$user_conf"

echo "Application stopped successfully!"

log_nodejs_event "INFO" "Application stopped for $domain"
$HESTIA/bin/v-log-action "$user" "Info" "Node.js" "Application stopped for $domain"

exit 0
