#!/bin/bash
# info: change database password on pgsql instance
# options: USER DATABASE DBUSER PASSWORD INSTANCE
#
# example: v-change-database-pgsql-password admin admin_mydb admin_myuser newpass123 ptest1
#
# This function changes a database user password on a specific PostgreSQL instance.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

user=$1
database=$2
dbuser=$3
password=$4
instance=${5:-default}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '4' "$#" 'USER DATABASE DBUSER PASSWORD [INSTANCE]'
is_object_valid 'user' 'USER' "$user"

if [ -z "$password" ]; then
    echo "Error: Password is required"
    exit 1
fi

#----------------------------------------------------------#
#                  Instance Configuration                  #
#----------------------------------------------------------#

PGSQL_PORT=5432

if [ "$instance" != "default" ]; then
    instance_file="$HESTIA/data/pgsql-instances.json"
    if [ -f "$instance_file" ] && command -v jq &>/dev/null; then
        inst_port=$(jq -r ".instances[] | select(.name==\"$instance\") | .port" "$instance_file" 2>/dev/null)
        [ -n "$inst_port" ] && [ "$inst_port" != "null" ] && PGSQL_PORT="$inst_port"
    fi
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Changing password for user: $dbuser on instance: $instance (port $PGSQL_PORT)..."

# Change password
sudo -u postgres psql -p $PGSQL_PORT -c "ALTER USER \"$dbuser\" WITH PASSWORD '$password';"

if [ $? -ne 0 ]; then
    echo "Error: Failed to change password"
    exit 1
fi

# Update password in user's config
user_dir="$HESTIA/data/users/$user"
user_db_conf="$user_dir/pgsql.conf"

if [ -f "$user_db_conf" ]; then
    sed -i "s/\(DB='$database'.*PASSWORD='\)[^']*'/\1$password'/" "$user_db_conf"
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "Password changed successfully!"
echo ""
echo "  Database:  $database"
echo "  User:      $dbuser"
echo "  Instance:  $instance"
echo ""

exit 0
