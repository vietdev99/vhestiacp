#!/bin/bash
# info: stop mongodb instance
# options: INSTANCE_NAME
#
# example: v-stop-mongodb-instance my-prod-db
#
# This function stops a MongoDB instance.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

instance_name=$1

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

if [ -z "$instance_name" ]; then
    echo "Error: Instance name is required"
    echo "Usage: v-stop-mongodb-instance INSTANCE_NAME"
    exit 1
fi

service_name="mongod-${instance_name}"

if ! systemctl list-unit-files | grep -q "$service_name"; then
    echo "Error: Instance '$instance_name' does not exist"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Stopping MongoDB instance: $instance_name"
systemctl stop "$service_name"

sleep 1

if ! systemctl is-active --quiet "$service_name"; then
    echo "  ✅ Instance stopped successfully"
    $HESTIA/bin/v-log-action "system" "Info" "MongoDB" "Instance '$instance_name' stopped"
    exit 0
else
    echo "  ❌ Failed to stop instance"
    exit 1
fi
