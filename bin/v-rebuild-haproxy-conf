#!/bin/bash
# info: rebuild HAProxy configuration from user configs
# options: [RESTART]
#
# example: v-rebuild-haproxy-conf
# example: v-rebuild-haproxy-conf yes
#
# This function rebuilds the main HAProxy configuration file by merging
# the base config with all user-level HAProxy backend configurations.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
restart=${1:-yes}

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if HAProxy is installed
if [ "$HAPROXY_SYSTEM" != "yes" ]; then
    exit 0
fi

if ! command -v haproxy &> /dev/null; then
    exit 0
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

HAPROXY_CONF="/etc/haproxy/haproxy.cfg"
HAPROXY_BASE="/etc/haproxy/haproxy.base.cfg"
HAPROXY_TMP="/tmp/haproxy.cfg.tmp"

# Backup current config
if [ -f "$HAPROXY_CONF" ]; then
    cp "$HAPROXY_CONF" "$HAPROXY_CONF.bak"
fi

# If base config doesn't exist, create it from current config
if [ ! -f "$HAPROXY_BASE" ]; then
    if [ -f "$HAPROXY_CONF" ]; then
        cp "$HAPROXY_CONF" "$HAPROXY_BASE"
    else
        echo "Error: No HAProxy base configuration found"
        exit 1
    fi
fi

# Start with base config
cp "$HAPROXY_BASE" "$HAPROXY_TMP"

# Add separator
cat >> "$HAPROXY_TMP" << 'EOF'

#=====================================================================
#                     USER BACKENDS (Auto-generated)
#=====================================================================
# DO NOT EDIT THIS SECTION MANUALLY
# Use v-add-user-haproxy-backend / v-delete-user-haproxy-backend
#=====================================================================
EOF

# Find and include all user backend configs
user_configs_found=0

for user_dir in $HESTIA/data/users/*/; do
    user=$(basename "$user_dir")

    # Skip if not a valid user
    [ ! -f "$user_dir/user.conf" ] && continue

    # Check if user has haproxy config
    if [ -f "$user_dir/haproxy.conf" ] && [ -s "$user_dir/haproxy.conf" ]; then
        user_backend_dir="$HOMEDIR/$user/conf/haproxy/backends"

        if [ -d "$user_backend_dir" ]; then
            for cfg in "$user_backend_dir"/*.cfg; do
                if [ -f "$cfg" ]; then
                    echo "" >> "$HAPROXY_TMP"
                    cat "$cfg" >> "$HAPROXY_TMP"
                    ((user_configs_found++))
                fi
            done
        fi
    fi
done

# Add footer
cat >> "$HAPROXY_TMP" << EOF

#=====================================================================
#                     END USER BACKENDS
#                     Total: $user_configs_found backend(s)
#=====================================================================
EOF

# Validate new config
if haproxy -c -f "$HAPROXY_TMP" > /dev/null 2>&1; then
    mv "$HAPROXY_TMP" "$HAPROXY_CONF"
    chmod 644 "$HAPROXY_CONF"

    # Restart HAProxy if requested
    if [ "$restart" = "yes" ]; then
        systemctl reload haproxy > /dev/null 2>&1 || systemctl restart haproxy > /dev/null 2>&1
    fi
else
    echo "Error: Invalid HAProxy configuration"
    echo "Keeping previous configuration"
    rm -f "$HAPROXY_TMP"
    exit 1
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

exit 0
