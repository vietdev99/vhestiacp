#!/bin/bash
# info: install RabbitMQ message broker
# options: [MANAGEMENT]
#
# example: v-add-sys-rabbitmq yes
#
# This function installs and configures RabbitMQ message broker.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

management=${1:-yes}

# Includes
source /etc/vhestia/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if already installed
if [ -f "/etc/rabbitmq/rabbitmq.conf" ]; then
    echo "RabbitMQ is already installed"
    exit 0
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "[ * ] Installing RabbitMQ..."

# Install Erlang and RabbitMQ
apt-get update > /dev/null 2>&1
apt-get install -y erlang-base erlang-asn1 erlang-crypto erlang-eldap erlang-ftp \
    erlang-inets erlang-mnesia erlang-os-mon erlang-parsetools erlang-public-key \
    erlang-runtime-tools erlang-snmp erlang-ssl erlang-syntax-tools erlang-tftp \
    erlang-tools erlang-xmerl > /dev/null 2>&1

# Add RabbitMQ repository
curl -1sLf "https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA" | gpg --dearmor > /usr/share/keyrings/rabbitmq-archive-keyring.gpg 2>/dev/null

# Add repository
cat > /etc/apt/sources.list.d/rabbitmq.list << EOF
deb [signed-by=/usr/share/keyrings/rabbitmq-archive-keyring.gpg] https://ppa1.novemberain.com/rabbitmq/rabbitmq-erlang/deb/ubuntu $(lsb_release -cs) main
deb [signed-by=/usr/share/keyrings/rabbitmq-archive-keyring.gpg] https://ppa1.novemberain.com/rabbitmq/rabbitmq-server/deb/ubuntu $(lsb_release -cs) main
EOF

apt-get update > /dev/null 2>&1
apt-get install -y rabbitmq-server > /dev/null 2>&1

# Start and enable service
systemctl enable rabbitmq-server > /dev/null 2>&1
systemctl start rabbitmq-server > /dev/null 2>&1

# Generate admin credentials
RABBITMQ_USER="admin"
RABBITMQ_PASSWORD=$(generate_password 16)

# Create admin user
rabbitmqctl add_user "$RABBITMQ_USER" "$RABBITMQ_PASSWORD" > /dev/null 2>&1
rabbitmqctl set_user_tags "$RABBITMQ_USER" administrator > /dev/null 2>&1
rabbitmqctl set_permissions -p / "$RABBITMQ_USER" ".*" ".*" ".*" > /dev/null 2>&1

# Remove default guest user for security
rabbitmqctl delete_user guest > /dev/null 2>&1

# Enable management plugin if requested
if [ "$management" = "yes" ]; then
    echo "    - Enabling management plugin..."
    rabbitmq-plugins enable rabbitmq_management > /dev/null 2>&1
    
    # Open firewall port for management UI
    if [ -x "$(command -v ufw)" ]; then
        ufw allow 15672/tcp comment "RabbitMQManagement" > /dev/null 2>&1
    fi
    if [ -f "$HESTIA/bin/v-add-firewall-rule" ]; then
        $HESTIA/bin/v-add-firewall-rule ACCEPT 0.0.0.0/0 15672 TCP "RabbitMQManagement" > /dev/null 2>&1
    fi
fi

# Open AMQP port
if [ -x "$(command -v ufw)" ]; then
    ufw allow 5672/tcp comment "RabbitMQAMQP" > /dev/null 2>&1
fi
if [ -f "$HESTIA/bin/v-add-firewall-rule" ]; then
    $HESTIA/bin/v-add-firewall-rule ACCEPT 0.0.0.0/0 5672 TCP "RabbitMQAMQP" > /dev/null 2>&1
fi

# Save credentials to Hestia config
mkdir -p "$HESTIA/conf"
cat > "$HESTIA/conf/rabbitmq.conf" << EOF
# RabbitMQ Configuration
# Generated by VHestiaCP

RABBITMQ_USER='$RABBITMQ_USER'
RABBITMQ_PASSWORD='$RABBITMQ_PASSWORD'
RABBITMQ_HOST='localhost'
RABBITMQ_PORT='5672'
RABBITMQ_MANAGEMENT_PORT='15672'
RABBITMQ_MANAGEMENT='$management'
EOF

chmod 640 "$HESTIA/conf/rabbitmq.conf"

# Update hestia.conf
if ! grep -q "RABBITMQ_SYSTEM" "$HESTIA/conf/hestia.conf"; then
    echo "RABBITMQ_SYSTEM='yes'" >> "$HESTIA/conf/hestia.conf"
fi

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo "    ✓ RabbitMQ installed successfully"
echo ""
echo "    Connection Details:"
echo "    ─────────────────────────────────"
echo "    AMQP Host:     localhost"
echo "    AMQP Port:     5672"
echo "    Username:      $RABBITMQ_USER"
echo "    Password:      $RABBITMQ_PASSWORD"
if [ "$management" = "yes" ]; then
    echo ""
    echo "    Management UI: http://localhost:15672"
fi
echo ""

# Logging
$HESTIA/bin/v-log-action "system" "Info" "Plugins" "RabbitMQ message broker installed"

exit 0
