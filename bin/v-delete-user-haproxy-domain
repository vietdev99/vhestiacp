#!/bin/bash
# info: delete HAProxy domain for user
# options: USER DOMAIN
#
# example: v-delete-user-haproxy-domain admin example.com
#
# This function removes a domain from user's HAProxy configuration.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
domain=$2

# Includes
# shellcheck source=/etc/vhestia/hestia.conf
source /etc/vhestia/hestia.conf
# shellcheck source=/usr/local/vhestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '2' "$#" 'USER DOMAIN'
is_format_valid 'user' 'domain'
is_object_valid 'user' 'USER' "$user"

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Define paths
HAPROXY_JSON="$HESTIA/data/users/$user/haproxy.json"
USER_HAPROXY_DIR="$HOMEDIR/$user/conf/haproxy"
BACKEND_DIR="$USER_HAPROXY_DIR/backends"
FRONTEND_DIR="$USER_HAPROXY_DIR/frontends"

# Check if haproxy.json exists
if [ ! -f "$HAPROXY_JSON" ]; then
    echo "Error: No HAProxy configuration found for user $user"
    exit 1
fi

# Check if domain exists in haproxy.json
if command -v jq &> /dev/null; then
    existing=$(jq -r ".domains[] | select(.domain == \"$domain\") | .domain" "$HAPROXY_JSON" 2>/dev/null)
    if [ -z "$existing" ]; then
        echo "Error: Domain $domain not found in HAProxy configuration"
        exit 1
    fi
else
    echo "Error: jq is required for JSON manipulation"
    exit 1
fi

# Remove domain from haproxy.json
jq "del(.domains[] | select(.domain == \"$domain\"))" "$HAPROXY_JSON" > "$HAPROXY_JSON.tmp" && mv "$HAPROXY_JSON.tmp" "$HAPROXY_JSON"

# Remove backend config file
BACKEND_CFG="$BACKEND_DIR/${domain}.cfg"
if [ -f "$BACKEND_CFG" ]; then
    rm -f "$BACKEND_CFG"
fi

# Regenerate frontend config with remaining domains
FRONTEND_CFG="$FRONTEND_DIR/${user}_domains.cfg"

# Check if there are any remaining domains
remaining_count=$(jq '.domains | length' "$HAPROXY_JSON" 2>/dev/null)

if [ "$remaining_count" -eq 0 ] || [ -z "$remaining_count" ]; then
    # No domains left, remove frontend config
    rm -f "$FRONTEND_CFG"
else
    # Regenerate frontend config with remaining domains
    {
        echo "# User: $user - HAProxy frontend rules"
        echo "# Generated: $(date)"
        echo "# DO NOT EDIT - Auto-generated by v-delete-user-haproxy-domain"
        echo ""

        # Generate ACLs and use_backend rules for each remaining domain
        jq -r '.domains[] | select(.enabled == true) | @json' "$HAPROXY_JSON" 2>/dev/null | while read -r domain_json; do
            d_domain=$(echo "$domain_json" | jq -r '.domain')
            d_aliases=$(echo "$domain_json" | jq -r '.aliases // [] | join(" ")')
            d_backend=$(echo "$domain_json" | jq -r '.backend.name')

            # ACL for main domain
            acl_name="host_${d_backend}"

            # Build ACL condition with domain and aliases
            acl_domains="$d_domain"
            if [ -n "$d_aliases" ] && [ "$d_aliases" != "null" ]; then
                acl_domains="$acl_domains $d_aliases"
            fi

            echo "acl $acl_name hdr(host) -i $acl_domains"
            echo "use_backend $d_backend if $acl_name"
            echo ""
        done
    } > "$FRONTEND_CFG"

    chmod 644 "$FRONTEND_CFG"
fi

# Rebuild HAProxy configuration
$HESTIA/bin/v-rebuild-haproxy-conf yes

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

$HESTIA/bin/v-log-action "user" "Info" "HAProxy" "Deleted HAProxy domain (User: $user, Domain: $domain)."

echo "HAProxy domain $domain deleted successfully"
exit 0
