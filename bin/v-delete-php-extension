#!/bin/bash
# info: remove PHP extension
# options: EXTENSION [PHP_VERSION]
#
# example: v-delete-php-extension redis 8.3
#
# This function removes a PHP extension for a given PHP version.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

extension=$1
php_version=${2:-}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'EXTENSION [PHP_VERSION]'

# Auto-detect PHP version if not provided
if [ -z "$php_version" ]; then
    php_version=$(php -v 2>/dev/null | head -1 | grep -oP '\d+\.\d+' | head -1)
    if [ -z "$php_version" ]; then
        echo "Error: Could not detect PHP version"
        exit 1
    fi
fi

# Validate PHP version format
if ! [[ "$php_version" =~ ^[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Invalid PHP version format. Use X.Y (e.g., 8.3)"
    exit 1
fi

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

package="php${php_version}-${extension}"

echo "Removing PHP extension: $extension for PHP $php_version..."

# Check if package is installed
if ! dpkg -l | grep -q "^ii.*$package"; then
    echo "Extension $extension is not installed for PHP $php_version"
    exit 0
fi

# Remove the package
export DEBIAN_FRONTEND=noninteractive
apt-get remove -y "$package"

if [ $? -ne 0 ]; then
    echo "Error: Failed to remove $package"
    exit 1
fi

# Restart PHP-FPM if running
fpm_service="php${php_version}-fpm"
if systemctl is-active --quiet "$fpm_service"; then
    echo "Restarting $fpm_service..."
    systemctl restart "$fpm_service"
fi

echo "PHP extension $extension removed successfully for PHP $php_version"

#----------------------------------------------------------#
#                       Logging                            #
#----------------------------------------------------------#

$BIN/v-log-action "system" "Info" "PHP" "Extension $extension removed for PHP $php_version"
log_event "$OK" "$ARGUMENTS"

exit 0
