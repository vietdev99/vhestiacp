#!/bin/bash
# info: list user HAProxy backends
# options: USER [FORMAT]
#
# example: v-list-user-haproxy admin
# example: v-list-user-haproxy admin json
#
# This function lists all HAProxy backends configured for a user.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
format=${2:-shell}

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'USER [FORMAT]'
is_format_valid 'user'
is_object_valid 'user' 'USER' "$user"

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

haproxy_conf="$HESTIA/data/users/$user/haproxy.conf"

# Check if user has any backends
if [ ! -f "$haproxy_conf" ] || [ ! -s "$haproxy_conf" ]; then
    if [ "$format" = "json" ]; then
        echo "[]"
    else
        echo "No HAProxy backends configured for user $user"
    fi
    exit 0
fi

#----------------------------------------------------------#
#                       Output                             #
#----------------------------------------------------------#

case "$format" in
    json)
        echo "["
        first=true
        while IFS= read -r line; do
            [ -z "$line" ] && continue

            # Parse fields
            eval "$line"

            # Check if backend config file exists and service is accessible
            status="active"
            backend_cfg="$HOMEDIR/$user/conf/haproxy/backends/${NAME}.cfg"
            if [ ! -f "$backend_cfg" ]; then
                status="missing"
            fi

            if [ "$first" = true ]; then
                first=false
            else
                echo ","
            fi

            cat << EOF
    {
        "NAME": "$NAME",
        "PORT": "$PORT",
        "FRONTEND_PORT": "$FRONTEND_PORT",
        "MODE": "$MODE",
        "BALANCE": "$BALANCE",
        "STATUS": "$status",
        "DATE": "$DATE"
    }
EOF
        done < "$haproxy_conf"
        echo ""
        echo "]"
        ;;

    plain)
        while IFS= read -r line; do
            [ -z "$line" ] && continue
            eval "$line"
            echo "NAME:$NAME PORT:$PORT FRONTEND_PORT:$FRONTEND_PORT MODE:$MODE BALANCE:$BALANCE DATE:$DATE"
        done < "$haproxy_conf"
        ;;

    *)
        echo "═══════════════════════════════════════════════════════════════════"
        echo "                HAProxy Backends for $user"
        echo "═══════════════════════════════════════════════════════════════════"
        echo ""
        printf "  %-15s %-8s %-10s %-6s %-12s %s\n" "NAME" "PORT" "FRONTEND" "MODE" "BALANCE" "DATE"
        echo "  ─────────────────────────────────────────────────────────────────"

        while IFS= read -r line; do
            [ -z "$line" ] && continue
            eval "$line"
            printf "  %-15s %-8s %-10s %-6s %-12s %s\n" "$NAME" "$PORT" "$FRONTEND_PORT" "$MODE" "$BALANCE" "$DATE"
        done < "$haproxy_conf"

        echo ""
        echo "═══════════════════════════════════════════════════════════════════"
        ;;
esac

exit 0
