#!/bin/bash
# info: list user HAProxy frontends and backends
# options: USER [FORMAT]
#
# example: v-list-user-haproxy admin
# example: v-list-user-haproxy admin json
#
# This function lists all HAProxy frontends and backends configured for a user.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
user=$1
format=${2:-shell}

# Includes
# shellcheck source=/etc/vhestia/hestia.conf
source /etc/vhestia/hestia.conf
# shellcheck source=/usr/local/vhestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

check_args '1' "$#" 'USER [FORMAT]'
is_format_valid 'user'
is_object_valid 'user' 'USER' "$user"

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

haproxy_conf="$HESTIA/data/users/$user/haproxy.conf"

# Check if user has any config
if [ ! -f "$haproxy_conf" ] || [ ! -s "$haproxy_conf" ]; then
    if [ "$format" = "json" ]; then
        echo '{"frontends":[],"backends":[]}'
    else
        echo "No HAProxy configuration for user $user"
    fi
    exit 0
fi

#----------------------------------------------------------#
#                       Output                             #
#----------------------------------------------------------#

case "$format" in
    json)
        # Build JSON output
        json_frontends="["
        json_backends="["
        first_frontend=true
        first_backend=true

        while IFS= read -r line; do
            [ -z "$line" ] && continue

            # Parse fields
            eval "$line"

            # Check if it's a frontend or backend
            if [ -n "$FRONTEND" ]; then
                # It's a frontend
                status="active"
                frontend_cfg="$HOMEDIR/$user/conf/haproxy/frontends/${FRONTEND}.cfg"
                if [ ! -f "$frontend_cfg" ]; then
                    status="missing"
                fi

                if [ "$first_frontend" = true ]; then
                    first_frontend=false
                else
                    json_frontends+=","
                fi

                json_frontends+="{\"NAME\":\"$FRONTEND\",\"PORT\":\"$PORT\",\"MODE\":\"$MODE\",\"DEFAULT_BACKEND\":\"$DEFAULT_BACKEND\",\"STATUS\":\"$status\",\"DATE\":\"$DATE\"}"

                # Clear variables
                unset FRONTEND PORT MODE DEFAULT_BACKEND
            elif [ -n "$NAME" ]; then
                # It's a backend
                status="active"
                backend_cfg="$HOMEDIR/$user/conf/haproxy/backends/${NAME}.cfg"
                if [ ! -f "$backend_cfg" ]; then
                    status="missing"
                fi

                if [ "$first_backend" = true ]; then
                    first_backend=false
                else
                    json_backends+=","
                fi

                json_backends+="{\"NAME\":\"$NAME\",\"PORT\":\"$PORT\",\"FRONTEND_PORT\":\"$FRONTEND_PORT\",\"MODE\":\"$MODE\",\"BALANCE\":\"$BALANCE\",\"STATUS\":\"$status\",\"DATE\":\"$DATE\"}"

                # Clear variables
                unset NAME PORT FRONTEND_PORT MODE BALANCE
            fi
        done < "$haproxy_conf"

        json_frontends+="]"
        json_backends+="]"

        echo "{\"frontends\":$json_frontends,\"backends\":$json_backends}"
        ;;

    plain)
        echo "# Frontends"
        while IFS= read -r line; do
            [ -z "$line" ] && continue
            eval "$line"
            if [ -n "$FRONTEND" ]; then
                echo "FRONTEND:$FRONTEND PORT:$PORT MODE:$MODE DEFAULT_BACKEND:$DEFAULT_BACKEND DATE:$DATE"
                unset FRONTEND PORT MODE DEFAULT_BACKEND
            fi
        done < "$haproxy_conf"

        echo "# Backends"
        while IFS= read -r line; do
            [ -z "$line" ] && continue
            eval "$line"
            if [ -n "$NAME" ]; then
                echo "BACKEND:$NAME PORT:$PORT FRONTEND_PORT:$FRONTEND_PORT MODE:$MODE BALANCE:$BALANCE DATE:$DATE"
                unset NAME PORT FRONTEND_PORT MODE BALANCE
            fi
        done < "$haproxy_conf"
        ;;

    *)
        echo "═══════════════════════════════════════════════════════════════════"
        echo "                HAProxy Configuration for $user"
        echo "═══════════════════════════════════════════════════════════════════"

        # Count frontends and backends
        frontend_count=$(grep -c "^FRONTEND=" "$haproxy_conf" 2>/dev/null || echo 0)
        backend_count=$(grep -c "^NAME=" "$haproxy_conf" 2>/dev/null || echo 0)

        echo ""
        echo "  Frontends: $frontend_count"
        echo "  Backends:  $backend_count"
        echo ""

        if [ "$frontend_count" -gt 0 ]; then
            echo "  ─────────────────────────────────────────────────────────────────"
            echo "  FRONTENDS"
            echo "  ─────────────────────────────────────────────────────────────────"
            printf "  %-15s %-8s %-6s %-20s %s\n" "NAME" "PORT" "MODE" "DEFAULT_BACKEND" "DATE"
            echo "  ─────────────────────────────────────────────────────────────────"

            while IFS= read -r line; do
                [ -z "$line" ] && continue
                eval "$line"
                if [ -n "$FRONTEND" ]; then
                    printf "  %-15s %-8s %-6s %-20s %s\n" "$FRONTEND" "$PORT" "$MODE" "${DEFAULT_BACKEND:-N/A}" "$DATE"
                    unset FRONTEND PORT MODE DEFAULT_BACKEND
                fi
            done < "$haproxy_conf"
            echo ""
        fi

        if [ "$backend_count" -gt 0 ]; then
            echo "  ─────────────────────────────────────────────────────────────────"
            echo "  BACKENDS"
            echo "  ─────────────────────────────────────────────────────────────────"
            printf "  %-15s %-8s %-10s %-6s %-12s %s\n" "NAME" "PORT" "FRONTEND" "MODE" "BALANCE" "DATE"
            echo "  ─────────────────────────────────────────────────────────────────"

            while IFS= read -r line; do
                [ -z "$line" ] && continue
                eval "$line"
                if [ -n "$NAME" ]; then
                    printf "  %-15s %-8s %-10s %-6s %-12s %s\n" "$NAME" "$PORT" "$FRONTEND_PORT" "$MODE" "$BALANCE" "$DATE"
                    unset NAME PORT FRONTEND_PORT MODE BALANCE
                fi
            done < "$haproxy_conf"
        fi

        echo ""
        echo "═══════════════════════════════════════════════════════════════════"
        ;;
esac

exit 0
