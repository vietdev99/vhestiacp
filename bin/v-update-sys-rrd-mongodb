#!/bin/bash
# info: update MongoDB rrd
# options: PERIOD
#
# example: v-update-sys-rrd-mongodb
#
# This function is for updating mongodb rrd database and graphic.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
period=${1-daily}

# Includes
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# load config file
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Check if MongoDB is installed
if [ ! -f "/etc/mongod.conf" ] && [ ! -d "/var/lib/mongodb" ]; then
	exit 0
fi

# Switching on time period
case $period in
	daily)
		start='-1d'
		end='now'
		grid='MINUTE:30:HOUR:1:HOUR:4:0:%H:%M'
		;;
	weekly)
		start='-7d'
		end='now'
		grid='HOUR:8:DAY:1:DAY:1:0:%a %d'
		;;
	monthly)
		start='-1m'
		end='now'
		grid='WEEK:1:WEEK:1:WEEK:1:0:%b %d'
		;;
	yearly)
		start='-1y'
		end='now'
		grid='MONTH:1:YEAR:1:MONTH:2:2419200:%b'
		;;
	*) exit "$E_RRD" ;;
esac

# Checking directory
if [ ! -d "$RRD/db" ]; then
	mkdir $RRD/db
fi

# Checking database
if [ ! -e "$RRD/db/mongodb_localhost.rrd" ]; then
	# Adding database
	# C = Connections, Q = Queries (opcounters), M = Memory (resident MB)
	rrdtool create $RRD/db/mongodb_localhost.rrd --step $RRD_STEP \
		DS:C:GAUGE:600:U:U \
		DS:Q:COUNTER:600:U:U \
		DS:M:GAUGE:600:U:U \
		RRA:AVERAGE:0.5:1:600 \
		RRA:AVERAGE:0.5:6:700 \
		RRA:AVERAGE:0.5:24:775 \
		RRA:AVERAGE:0.5:288:797 \
		RRA:MAX:0.5:1:600 \
		RRA:MAX:0.5:6:700 \
		RRA:MAX:0.5:24:775 \
		RRA:MAX:0.5:288:797
fi

if [ "$period" = 'daily' ]; then
	# Get MongoDB stats using mongosh or mongo
	if command -v mongosh &> /dev/null; then
		mongo_cmd="mongosh"
	elif command -v mongo &> /dev/null; then
		mongo_cmd="mongo"
	else
		exit 0
	fi

	# Try to get server status
	stats=$($mongo_cmd --quiet --eval '
		try {
			var status = db.serverStatus();
			var conn = status.connections ? status.connections.current : 0;
			var queries = status.opcounters ? (status.opcounters.query + status.opcounters.insert + status.opcounters.update + status.opcounters.delete) : 0;
			var mem = status.mem ? status.mem.resident : 0;
			print(conn + ":" + queries + ":" + mem);
		} catch(e) {
			print("0:0:0");
		}
	' admin 2>/dev/null)

	if [ -z "$stats" ] || [ "$stats" = "0:0:0" ]; then
		# Try without auth
		stats=$($mongo_cmd --quiet --eval '
			try {
				var status = db.serverStatus();
				var conn = status.connections ? status.connections.current : 0;
				var queries = status.opcounters ? (status.opcounters.query + status.opcounters.insert + status.opcounters.update + status.opcounters.delete) : 0;
				var mem = status.mem ? status.mem.resident : 0;
				print(conn + ":" + queries + ":" + mem);
			} catch(e) {
				print("0:0:0");
			}
		' 2>/dev/null)
	fi

	# Parse stats
	connections=$(echo "$stats" | cut -d':' -f1)
	queries=$(echo "$stats" | cut -d':' -f2)
	memory=$(echo "$stats" | cut -d':' -f3)

	# Default values if empty
	connections=${connections:-0}
	queries=${queries:-0}
	memory=${memory:-0}

	# Updating rrd
	rrdtool update $RRD/db/mongodb_localhost.rrd N:$connections:$queries:$memory
fi

# Updating graph
rrdtool graph $RRD/db/$period-mongodb_localhost.png \
	--imgformat PNG \
	--height="150" \
	--width="670" \
	--start "$start" \
	--end "$end" \
	--vertical-label "Count" \
	--x-grid "$grid" \
	-c "BACK#ffffff" \
	-c "SHADEA#ffffff" \
	-c "SHADEB#ffffff" \
	-c "FONT#555555" \
	-c "CANVAS#302c2d" \
	-c "GRID#666666" \
	-c "MGRID#AAAAAA" \
	-c "FRAME#302c2d" \
	-c "ARROW#FFFFFF" \
	DEF:c=$RRD/db/mongodb_localhost.rrd:C:AVERAGE \
	DEF:q=$RRD/db/mongodb_localhost.rrd:Q:AVERAGE \
	DEF:m=$RRD/db/mongodb_localhost.rrd:M:AVERAGE \
	COMMENT:'\r' \
	LINE1:c#73d216:"Connections" \
	GPRINT:c:'LAST: Current\:''%8.0lf' \
	GPRINT:c:'MIN: Min\:''%8.0lf' \
	GPRINT:c:'MAX: Max\:''%8.0lf\j' \
	LINE1:q#3465a4:"Queries    " \
	GPRINT:q:'LAST:Current\:''%8.0lf' \
	GPRINT:q:'MIN:Min\:''%8.0lf' \
	GPRINT:q:'MAX:Max\:''%8.0lf\j' \
	AREA:m#f57900:"Memory(MB) " \
	GPRINT:m:'LAST:Current\:''%8.0lf' \
	GPRINT:m:'MIN:Min\:''%8.0lf' \
	GPRINT:m:'MAX:Max\:''%8.0lf\j' &> /dev/null
result=$?

if [ "$result" -ne 0 ]; then
	exit "$E_RRD"
fi

#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

exit
