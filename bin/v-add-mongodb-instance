#!/bin/bash
# info: add mongodb instance
# options: INSTANCE_NAME PORT [CLUSTER_MODE] [REPLICA_SET_NAME]
#
# example: v-add-mongodb-instance my-prod-db 27017
# example: v-add-mongodb-instance my-test-db 27018 replicaset rs0
#
# This function creates a new MongoDB instance with its own
# data directory, configuration file, and systemd service.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

# Argument definition
instance_name=$1
port=$2
cluster_mode=${3:-standalone}       # standalone, replicaset, sharding
replica_set_name=${4:-rs0}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source $HESTIA/func/mongodb.sh 2>/dev/null || true
source_conf "$HESTIA/conf/hestia.conf"

# Directories
INSTANCES_DATA_DIR="/var/lib/mongodb-instances"
INSTANCES_CONF_DIR="/etc/mongodb-instances"
INSTANCES_META_FILE="$HESTIA/data/mongodb-instances.json"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root"
    exit 1
fi

# Check required arguments
if [ -z "$instance_name" ]; then
    echo "Error: Instance name is required"
    echo "Usage: v-add-mongodb-instance INSTANCE_NAME PORT [CLUSTER_MODE] [REPLICA_SET_NAME]"
    exit 1
fi

if [ -z "$port" ]; then
    echo "Error: Port is required"
    echo "Usage: v-add-mongodb-instance INSTANCE_NAME PORT [CLUSTER_MODE] [REPLICA_SET_NAME]"
    exit 1
fi

# Validate instance name (alphanumeric + dash only)
if ! [[ "$instance_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
    echo "Error: Instance name must start with a letter and contain only letters, numbers, dashes, and underscores"
    exit 1
fi

# Validate port number
if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1024 ] || [ "$port" -gt 65535 ]; then
    echo "Error: Port must be a number between 1024 and 65535"
    exit 1
fi

# Check if port is already in use
if ss -tlnp | grep -q ":${port} "; then
    echo "Error: Port $port is already in use"
    exit 1
fi

# Validate cluster mode
case "$cluster_mode" in
    standalone|replicaset|sharding) ;;
    *)
        echo "Error: Invalid cluster mode. Use: standalone, replicaset, sharding"
        exit 1
        ;;
esac

# Check if instance already exists
if [ -d "$INSTANCES_DATA_DIR/$instance_name" ]; then
    echo "Error: Instance '$instance_name' already exists"
    exit 1
fi

# Check if MongoDB is installed
if ! command -v mongod &>/dev/null; then
    echo "Error: MongoDB is not installed. Run v-add-sys-mongodb first."
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Creating MongoDB instance: $instance_name"
echo "  - Port: $port"
echo "  - Cluster Mode: $cluster_mode"

# Create directories
echo "Creating directories..."
mkdir -p "$INSTANCES_DATA_DIR/$instance_name/data"
mkdir -p "$INSTANCES_CONF_DIR"
mkdir -p "/var/log/mongodb-instances"
mkdir -p "$HESTIA/data"

# Set ownership
chown -R mongodb:mongodb "$INSTANCES_DATA_DIR/$instance_name"
chown mongodb:mongodb "/var/log/mongodb-instances"

# Generate keyfile for replicaset/sharding
keyfile_path=""
if [ "$cluster_mode" != "standalone" ]; then
    keyfile_path="$INSTANCES_DATA_DIR/$instance_name/keyfile"
    echo "Generating keyfile..."
    openssl rand -base64 756 > "$keyfile_path"
    chmod 400 "$keyfile_path"
    chown mongodb:mongodb "$keyfile_path"
fi

# Get MongoDB version for config compatibility
mongo_version=$(mongod --version | grep "db version" | sed 's/.*v//' | cut -d. -f1)

# Create configuration file
echo "Creating configuration..."
config_file="$INSTANCES_CONF_DIR/${instance_name}.conf"

cat > "$config_file" << EOF
# VHestiaCP MongoDB Instance Configuration
# Instance: $instance_name

storage:
  dbPath: $INSTANCES_DATA_DIR/$instance_name/data
EOF

# Add journal setting for MongoDB < 8
if [ "$mongo_version" -lt 8 ] 2>/dev/null; then
    cat >> "$config_file" << EOF
  journal:
    enabled: true
EOF
fi

cat >> "$config_file" << EOF

systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb-instances/${instance_name}.log

net:
  port: $port
  bindIp: 127.0.0.1

processManagement:
  timeZoneInfo: /usr/share/zoneinfo
EOF

# Add security and replication for non-standalone modes
if [ "$cluster_mode" != "standalone" ]; then
    cat >> "$config_file" << EOF

security:
  keyFile: $keyfile_path
  authorization: enabled

replication:
  replSetName: "$replica_set_name"
EOF
fi

# Add sharding config if needed
if [ "$cluster_mode" == "sharding" ]; then
    cat >> "$config_file" << EOF

sharding:
  clusterRole: shardsvr
EOF
fi

chown root:mongodb "$config_file"
chmod 644 "$config_file"

# Create systemd service
echo "Creating systemd service..."
service_name="mongod-${instance_name}"
service_file="/etc/systemd/system/${service_name}.service"

cat > "$service_file" << EOF
[Unit]
Description=MongoDB Database Server (Instance: $instance_name)
Documentation=https://docs.mongodb.org/manual
After=network-online.target
Wants=network-online.target

[Service]
User=mongodb
Group=mongodb
EnvironmentFile=-/etc/default/mongod
ExecStart=/usr/bin/mongod --config $config_file
PIDFile=/run/mongodb-${instance_name}.pid
# file size
LimitFSIZE=infinity
# cpu time
LimitCPU=infinity
# virtual memory size
LimitAS=infinity
# open files
LimitNOFILE=64000
# processes/threads
LimitNPROC=64000
# locked memory
LimitMEMLOCK=infinity
# total threads (user+kernel)
TasksMax=infinity
TasksAccounting=false
# Recommended limits for mongod as specified in
# https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings

[Install]
WantedBy=multi-user.target
EOF

chmod 644 "$service_file"

# Reload systemd and enable service
systemctl daemon-reload
systemctl enable "$service_name"

# Start the instance
echo "Starting instance..."
systemctl start "$service_name"

# Wait for startup
sleep 3

# Check status
if systemctl is-active --quiet "$service_name"; then
    echo "  ✅ Instance started successfully"
else
    echo "  ⚠️ Instance failed to start"
    systemctl status "$service_name" --no-pager || true
    exit 1
fi

# Update metadata file
echo "Updating metadata..."
created_at=$(date -Iseconds)

# Initialize metadata file if not exists
if [ ! -f "$INSTANCES_META_FILE" ]; then
    echo '{"instances":[]}' > "$INSTANCES_META_FILE"
fi

# Add instance to metadata using jq if available, otherwise use sed
if command -v jq &>/dev/null; then
    tmp_file=$(mktemp)
    jq --arg name "$instance_name" \
       --arg port "$port" \
       --arg dataDir "$INSTANCES_DATA_DIR/$instance_name/data" \
       --arg configPath "$config_file" \
       --arg serviceName "$service_name" \
       --arg clusterMode "$cluster_mode" \
       --arg replicaSetName "$replica_set_name" \
       --arg keyfilePath "$keyfile_path" \
       --arg createdAt "$created_at" \
       '.instances += [{
           "name": $name,
           "port": ($port | tonumber),
           "dataDir": $dataDir,
           "configPath": $configPath,
           "serviceName": $serviceName,
           "clusterMode": $clusterMode,
           "replicaSetName": $replicaSetName,
           "keyfilePath": $keyfilePath,
           "createdAt": $createdAt,
           "pbm": {"enabled": false}
       }]' "$INSTANCES_META_FILE" > "$tmp_file" && mv "$tmp_file" "$INSTANCES_META_FILE"
else
    # Fallback: simple append (less robust)
    echo "Warning: jq not installed, metadata may not be properly formatted"
fi

chmod 644 "$INSTANCES_META_FILE"

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "════════════════════════════════════════════════════════════"
echo "  MongoDB Instance Created Successfully!"
echo "════════════════════════════════════════════════════════════"
echo ""
echo "  Instance Name:    $instance_name"
echo "  Port:             $port"
echo "  Cluster Mode:     $cluster_mode"
echo "  Data Directory:   $INSTANCES_DATA_DIR/$instance_name/data"
echo "  Config File:      $config_file"
echo "  Service Name:     $service_name"
echo ""
echo "  Commands:"
echo "    Start:   systemctl start $service_name"
echo "    Stop:    systemctl stop $service_name"
echo "    Status:  systemctl status $service_name"
echo ""
if [ "$cluster_mode" != "standalone" ]; then
    echo "  ReplicaSet Name:  $replica_set_name"
    echo "  Keyfile:          $keyfile_path"
    echo ""
fi
echo "════════════════════════════════════════════════════════════"

# Logging
$HESTIA/bin/v-log-action "system" "Info" "MongoDB" "Instance '$instance_name' created on port $port"

exit 0
