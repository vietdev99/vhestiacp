#!/bin/bash
# info: reset/create mongodb password for mongodb instance
# options: INSTANCE
#
# example: v-reset-mongodb-instance-password my-db
#
# This function resets the admin password for a MongoDB instance.

#----------------------------------------------------------#
#                Variables & Functions                     #
#----------------------------------------------------------#

instance=${1}

# Includes
source /etc/hestiacp/hestia.conf
source $HESTIA/func/main.sh
source_conf "$HESTIA/conf/hestia.conf"

#----------------------------------------------------------#
#                    Verifications                         #
#----------------------------------------------------------#

if [ -z "$instance" ]; then
    echo "Error: Instance name is required"
    exit 1
fi

# Load instance port
instance_file="$HESTIA/data/mongodb-instances.json"
PORT=27017
if [ -f "$instance_file" ] && command -v jq &>/dev/null; then
    inst_port=$(jq -r ".instances[] | select(.name==\"$instance\") | .port" "$instance_file" 2>/dev/null)
    [ -n "$inst_port" ] && [ "$inst_port" != "null" ] && PORT="$inst_port"
fi

# Check if running
if ! systemctl is-active --quiet "mongod-$instance"; then
    echo "Error: Instance mongod-$instance is not running"
    exit 1
fi

#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

echo "Resetting password for MongoDB instance: $instance..."

# Generate new password
NEW_PASSWORD=$(generate_password)

# Get Old Password to authenticate
CONF_FILE="$HESTIA/conf/mongodb-${instance}.conf"
OLD_PASSWORD=""
if [ -f "$CONF_FILE" ]; then
    source "$CONF_FILE"
    OLD_PASSWORD="$ROOT_PASSWORD"
fi

# Try to update password
# 1. Try with old password
if [ -n "$OLD_PASSWORD" ]; then
    mongosh --port $PORT -u admin -p "$OLD_PASSWORD" --authenticationDatabase admin --eval "db.getSiblingDB('admin').changeUserPassword('admin', '$NEW_PASSWORD')" > /dev/null 2>&1
    RET=$?
else
    # 2. Try without password (localhost exception or no auth)
    mongosh --port $PORT --eval "db.getSiblingDB('admin').changeUserPassword('admin', '$NEW_PASSWORD')" > /dev/null 2>&1
    RET=$?
fi

# If failed, maybe user doesn't exist? Try to create it (without auth)
if [ $RET -ne 0 ]; then
    echo "Update failed, trying to create user..."
    mongosh --port $PORT --eval "db.getSiblingDB('admin').createUser({user: 'admin', pwd: '$NEW_PASSWORD', roles: ['root']})" > /dev/null 2>&1
    RET=$?
fi

if [ $RET -ne 0 ]; then
    echo "Error: Failed to reset password. Access denied or instance locked."
    exit 1
fi

# Save password to config
cat > "$CONF_FILE" <<EOF
ROOT_PASSWORD='$NEW_PASSWORD'
EOF
chmod 600 "$CONF_FILE"

#----------------------------------------------------------#
#                       Result                             #
#----------------------------------------------------------#

echo ""
echo "MongoDB instance password reset successfully!"
echo "Password saved to: $CONF_FILE"

exit 0
