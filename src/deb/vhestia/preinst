#!/bin/bash
#==========================================================================
# VHestiaCP - Pre Installation Script
#==========================================================================

set -e

VHESTIA='/usr/local/vhestia'

# Run triggers only on updates (existing installation)
if [ ! -e "$VHESTIA/data/users/admin" ] && [ ! -e "/usr/local/hestia/data/users/admin" ]; then
    exit 0
fi

# Create config directory if it doesn't exist
if [ ! -e "/etc/vhestia/vhestia.conf" ]; then
    mkdir -p /etc/vhestia
    cat > /etc/vhestia/vhestia.conf << 'EOF'
# VHestiaCP Configuration
# Do not edit this file directly, use /etc/vhestia/local.conf instead

export VHESTIA='/usr/local/vhestia'
export HESTIA="$VHESTIA"

[[ -f /etc/vhestia/local.conf ]] && source /etc/vhestia/local.conf
EOF
fi

# Configure apt to retry downloading on error
if [ ! -f /etc/apt/apt.conf.d/80-retries ]; then
    echo "APT::Acquire::Retries \"3\";" > /etc/apt/apt.conf.d/80-retries
fi

# Get current version
VHESTIA_V=$(dpkg -s vhestia 2>/dev/null | grep -i version | awk '{ print $2 }' || echo "")

exit 0
