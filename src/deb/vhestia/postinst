#!/bin/bash
#==========================================================================
# VHestiaCP - Post Installation Script
#==========================================================================

set -e

VHESTIA='/usr/local/vhestia'

###############################################################
#                Create Backward Compatibility                 #
###############################################################

# Create symlink for backward compatibility
if [ ! -e /usr/local/hestia ] && [ ! -L /usr/local/hestia ]; then
    ln -sf /usr/local/vhestia /usr/local/hestia
    echo "Created symlink: /usr/local/hestia -> /usr/local/vhestia"
fi

# Create config symlink for backward compatibility
if [ ! -e /etc/hestiacp ] && [ ! -L /etc/hestiacp ]; then
    ln -sf /etc/vhestia /etc/hestiacp
    echo "Created symlink: /etc/hestiacp -> /etc/vhestia"
fi

###############################################################
#                  Create Config Directory                     #
###############################################################

mkdir -p /etc/vhestia

# Create main config if it doesn't exist
if [ ! -f /etc/vhestia/vhestia.conf ]; then
    cat > /etc/vhestia/vhestia.conf << 'EOF'
# VHestiaCP Configuration
# Do not edit this file directly, it may be overwritten on upgrade
# Use /etc/vhestia/local.conf for custom settings

export VHESTIA='/usr/local/vhestia'
export HESTIA="$VHESTIA"

[[ -f /etc/vhestia/local.conf ]] && source /etc/vhestia/local.conf
EOF
    echo "Created /etc/vhestia/vhestia.conf"
fi

###############################################################
#                    Set Permissions                           #
###############################################################

# Set executable permissions on bin scripts
if [ -d "$VHESTIA/bin" ]; then
    chmod -R 755 "$VHESTIA/bin"
fi

# Set executable permissions on func scripts
if [ -d "$VHESTIA/func" ]; then
    chmod -R 644 "$VHESTIA/func"
    chmod 755 "$VHESTIA/func"
fi

###############################################################
#                  Run Upgrade Routines                        #
###############################################################

# Only run upgrade routines if data directory exists (existing installation)
if [ -d "$VHESTIA/data/users/" ]; then
    # Source configuration
    if [ -f /etc/vhestia/vhestia.conf ]; then
        source /etc/vhestia/vhestia.conf
    fi

    # Load functions
    if [ -f "$VHESTIA/func/main.sh" ]; then
        source "$VHESTIA/func/main.sh"
    fi

    # Load upgrade functions if available
    if [ -f "$VHESTIA/func/upgrade.sh" ]; then
        source "$VHESTIA/func/upgrade.sh"

        if [ -f "$VHESTIA/conf/hestia.conf" ] || [ -f "$VHESTIA/conf/vhestia.conf" ]; then
            source_conf "$VHESTIA/conf/hestia.conf" 2>/dev/null || true
            source_conf "$VHESTIA/conf/vhestia.conf" 2>/dev/null || true
        fi

        # Get new version
        new_version=$(dpkg -l | awk '$2=="vhestia" { print $3 }')

        # Detect OS
        detect_os 2>/dev/null || true

        # Run pre-install hook if exists
        if [ -e "/etc/vhestia/hooks/pre_install.sh" ]; then
            /etc/vhestia/hooks/pre_install.sh
        fi

        # Run upgrade routines
        if type upgrade_start_routine &>/dev/null; then
            echo "Running VHestiaCP upgrade routines..."
            upgrade_start_routine 2>/dev/null || true
        fi

        # Set new version
        if type upgrade_set_version &>/dev/null; then
            upgrade_set_version "$new_version" 2>/dev/null || true
        fi

        # Run post-install hook if exists
        if [ -e "/etc/vhestia/hooks/post_install.sh" ]; then
            /etc/vhestia/hooks/post_install.sh
        fi
    fi
fi

echo "VHestiaCP installation completed successfully!"
exit 0
